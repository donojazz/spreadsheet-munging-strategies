## Sentinel values in non-text columns {#tidy-sentinel}

R packages like [readr](http://readr.tidyverse.org/) recognise `NA` as a
sentinel value that means "Not Applicable", or "Not Available", or anything you
want.  It doesn't affect the data type of a column when `NA` is one of the
values.  Some datasets use other symbols as a sentinel value, e.g. `N/A` or `.`,
or a combination, in which case you can instruct `readr` to interpret those
values as sentinels, and it will import them all as `NA`.

But what if the data uses more than one *kind* of sentinel value.  For example,
Statistics New Zealand uses `…` to mean "Not applicable", and `..C` to mean
"Confidentialised".  Most tools will either regard both values as `NA`, or
coerce the whole column to characters.

```{r}
read_csv("a, b,   c
          1, 2,   3
          4, …, ..C",
         na = c("…", "..C")) # Regard both values as NA

read_csv("a, b,   c
          1, 2,   3
          4, …, ..C",
         na = "")              # Coerce the whole column to characters
```

A better procedure is to import the sentinel values into their own column, or
even into separate `TRUE`/`FALSE` columns for each kind of sentinel.

Note that sentinel values relate the the value in the cell, rather than to the
whole row, so the first step is to make the dataset *extra-tidy* as in the
section "Already a tidy table but with meaningful formatting of single cells".

```{r}
# Tidy
path <- system.file("extdata", "worked-examples.xlsx", package = "unpivotr")
x <- read_excel(path, sheet = "sentinels")
x

# Extra-tidy
extra_tidy <-
  gather(x, variable, value, -Name) %>%
  arrange(Name, variable)
extra_tidy
```

With an extra-tidy dataset, the sentinels can now be appended to the values of
individual variables, rather than to whole observations.

```{r}
# Extra-tidy, with row and column numbers of the original variables, and the
# sentinels omitted
extra_tidy <-
  read_excel(path, sheet = "sentinels", na = c("NA", "…", "..C")) %>%
  mutate(row = row_number() + 1L) %>%
  gather(variable, value, -row, -Name) %>%
  group_by(row) %>%
  mutate(col = row_number() + 1L) %>%
  ungroup() %>%
  select(row, col, Name, variable, value) %>%
  arrange(row, col)
extra_tidy

# Import all the cells, and filter for sentinel values
sentinels <-
  xlsx_cells(path, sheet = "sentinels") %>%
  filter(character %in% c("NA", "…", "..C")) %>%
  mutate(sentinel = character) %>%
  select(row, col, sentinel)
sentinels

# Join the `sentinel` column to the rest of the data
left_join(extra_tidy, sentinels, by = c("row", "col"))
```

Here's another version using only tidyxl and unpivotr, which provides
`isolate_sentinels()` to make this much more straightforward.

```{r}
xlsx_cells(path, sheet = "sentinels") %>%
  select(row, col, data_type, character, numeric) %>%
  isolate_sentinels(character, c("NA", "…", "..C")) %>%
  behead("W", Name) %>%
  behead("N", variable) %>%
  select(Name, variable, character, numeric, sentinel)
```

