<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Spreadsheet Munging Strategies</title>
  <meta name="description" content="Spreadsheet Munging Strategies">
  <meta name="generator" content="bookdown 0.7.4 and GitBook 2.6.7">

  <meta property="og:title" content="Spreadsheet Munging Strategies" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Spreadsheet Munging Strategies" />
  
  
  

<meta name="author" content="Duncan Garmonsway">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="tidy-formatted-cells.html">
<link rel="next" href="already-a-tidy-table-but-with-text-sentinel-values-in-non-text-columns.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="setup.html"><a href="setup.html#packages"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="setup.html"><a href="setup.html#data"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidy-clean.html"><a href="tidy-clean.html"><i class="fa fa-check"></i><b>2</b> Clean, tidy tables</a></li>
<li class="chapter" data-level="3" data-path="tidy-tables-but-with-gotchas.html"><a href="tidy-tables-but-with-gotchas.html"><i class="fa fa-check"></i><b>3</b> Tidy tables but with gotchas</a><ul>
<li class="chapter" data-level="3.1" data-path="tidy-tables-but-with-gotchas.html"><a href="tidy-tables-but-with-gotchas.html#transposed-headers-in-the-first-row-data-extends-to-the-right"><i class="fa fa-check"></i><b>3.1</b> Transposed (headers in the first row, data extends to the right)</a></li>
<li class="chapter" data-level="3.2" data-path="tidy-tables-but-with-gotchas.html"><a href="tidy-tables-but-with-gotchas.html#other-stuff-on-the-same-sheet"><i class="fa fa-check"></i><b>3.2</b> Other stuff on the same sheet</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="tidy-formatted-rows.html"><a href="tidy-formatted-rows.html"><i class="fa fa-check"></i><b>4</b> Meaningfully formatted rows</a></li>
<li class="chapter" data-level="5" data-path="tidy-formatted-cells.html"><a href="tidy-formatted-cells.html"><i class="fa fa-check"></i><b>5</b> Meaningfully formatted cells</a></li>
<li class="chapter" data-level="6" data-path="multiple-formatting.html"><a href="multiple-formatting.html"><i class="fa fa-check"></i><b>6</b> Layered meaningful formatting</a></li>
<li class="chapter" data-level="7" data-path="already-a-tidy-table-but-with-text-sentinel-values-in-non-text-columns.html"><a href="already-a-tidy-table-but-with-text-sentinel-values-in-non-text-columns.html"><i class="fa fa-check"></i><b>7</b> Already a tidy table but with text sentinel values in non-text columns</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spreadsheet Munging Strategies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="multiple-formatting" class="section level1">
<h1><span class="header-section-number">6</span> Layered meaningful formatting</h1>
<p>Sometimes different kinds of formatting relate to clearly different aspects of
an observation, e.g. yellow highlight for “uncertain data” and red text for
“product no longer available”. Both yellow highlighting and red text in the
same row would indicate uncertain data and unavailability of the product at the
same time.</p>
<p>Deal with it by reading each kind of formatting into a separate column,
e.g. fill colour into one column, font colour into another, bold/not-bold into a
another, etc.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Step 1: import the table taking only cell values and ignoring the formatting</span>
x &lt;-<span class="st"> </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;combined-highlights&quot;</span>)

<span class="co"># Step 2: import one kind of formatting of one column of the table</span>

<span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span>
<span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span>
fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb
font_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb

<span class="co"># Import all the cells, filter out the header row, filter for the first column,</span>
<span class="co"># and create a new column `fill` of the fill colours, by looking up the</span>
<span class="co"># local_format_id of each cell in the `formats` pallette.</span>
formats &lt;-
<span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;combined-highlights&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span>, col <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the header row</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id],
         <span class="dt">font_colour =</span> font_colours[local_format_id]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(fill_colour, font_colour)

<span class="co"># Step 3: append the `fill` column to the rest of the data</span>
<span class="kw">bind_cols</span>(x, formats)</code></pre>
<pre><code>## # A tibble: 4 x 5
##   Name     Weight Price fill_colour font_colour
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      
## 1 Knife        7.    8. &lt;NA&gt;        FF000000   
## 2 Fork         5.    6. FFFFFF00    FF000000   
## 3 Spoon        3.    4. &lt;NA&gt;        FFFF0000   
## 4 Teaspoon     1.    2. FFFFFF00    FFFF0000</code></pre>
<p>Here’s the same thing, but using only tidyxl and unpivotr.</p>
<pre class="sourceCode r"><code class="sourceCode r">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb
font_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb

cells &lt;-
<span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;combined-highlights&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id],
         <span class="dt">font_colour =</span> font_colours[local_format_id]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, fill_colour, font_colour) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, header) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, Name) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>col, <span class="op">-</span>character)

values &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>fill_colour, <span class="op">-</span>font_colour) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(header, numeric)

formats &lt;-<span class="st"> </span><span class="kw">distinct</span>(cells, row, fill_colour, font_colour)

<span class="kw">left_join</span>(values, formats, <span class="dt">by =</span> <span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row)</code></pre>
<pre><code>## # A tibble: 4 x 6
##   data_type Name     Price Weight fill_colour font_colour
##   &lt;chr&gt;     &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      
## 1 numeric   Knife       8.     7. &lt;NA&gt;        FF000000   
## 2 numeric   Fork        6.     5. FFFFFF00    &lt;NA&gt;       
## 3 numeric   Spoon       4.     3. &lt;NA&gt;        FFFF0000   
## 4 numeric   Teaspoon    2.     1. FFFFFF00    FFFF0000</code></pre>
<p>Different kinds of formatting might also represent different levels of a
hierarchy, e.g.</p>
<table>
<thead>
<tr class="header">
<th align="left">formatting</th>
<th align="left">interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">none</td>
<td align="left">good</td>
</tr>
<tr class="even">
<td align="left">italic</td>
<td align="left">satisfactory</td>
</tr>
<tr class="odd">
<td align="left">bold</td>
<td align="left">poor</td>
</tr>
<tr class="even">
<td align="left">bold &amp; italic</td>
<td align="left">fail</td>
</tr>
</tbody>
</table>
<p>When each kind of formatting relates to a different level of one hierarchy,
import the different kinds of formatting into different columns, and then
combine them into a third column, perhaps using <code>paste()</code>, or <code>case_when()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Step 1: import the table taking only cell values and ignoring the formatting</span>
x &lt;-<span class="st"> </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;highlight-hierarchy&quot;</span>)
x</code></pre>
<pre><code>## # A tibble: 4 x 2
##   Name     Score
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 Matilda     7.
## 2 Nicholas    5.
## 3 Olivia      3.
## 4 Paul        1.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Step 2: import one kind of formatting of one column of the table</span>

<span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span>
<span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span>
bold &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>bold
italic &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>italic

<span class="co"># Import all the cells, filter out the header row, filter for the first column,</span>
<span class="co"># and create a new column `fill` of the fill colours, by looking up the</span>
<span class="co"># local_format_id of each cell in the `formats` pallette.</span>
formats &lt;-
<span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;highlight-hierarchy&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span>, col <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the header row</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">bold =</span> bold[local_format_id],
         <span class="dt">italic =</span> italic[local_format_id]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">grade =</span> <span class="kw">case_when</span>(bold <span class="op">&amp;</span><span class="st"> </span>italic <span class="op">~</span><span class="st"> &quot;fail&quot;</span>,
                           bold <span class="op">~</span><span class="st"> &quot;poor&quot;</span>,
                           italic <span class="op">~</span><span class="st"> &quot;satisfactory&quot;</span>,
                           <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;good&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(bold, italic, grade)

<span class="co"># Step 3: append the `fill` column to the rest of the data</span>
<span class="kw">bind_cols</span>(x, formats)</code></pre>
<pre><code>## # A tibble: 4 x 5
##   Name     Score bold  italic grade       
##   &lt;chr&gt;    &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;chr&gt;       
## 1 Matilda     7. FALSE FALSE  good        
## 2 Nicholas    5. FALSE TRUE   satisfactory
## 3 Olivia      3. TRUE  FALSE  poor        
## 4 Paul        1. TRUE  TRUE   fail</code></pre>
<p>Here it is again, using only tidyxl and unpivotr.</p>
<pre class="sourceCode r"><code class="sourceCode r">bold &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>bold
italic &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>italic

<span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;highlight-hierarchy&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">bold =</span> bold[local_format_id],
         <span class="dt">italic =</span> italic[local_format_id]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">grade =</span> <span class="kw">case_when</span>(bold <span class="op">&amp;</span><span class="st"> </span>italic <span class="op">~</span><span class="st"> &quot;fail&quot;</span>,
                           bold <span class="op">~</span><span class="st"> &quot;poor&quot;</span>,
                           italic <span class="op">~</span><span class="st"> &quot;satisfactory&quot;</span>,
                           <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;good&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, bold, italic, grade) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, header) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>col) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spatter</span>(header)</code></pre>
<pre><code>## # A tibble: 4 x 6
##     row bold  italic grade        Name     Score
##   &lt;int&gt; &lt;lgl&gt; &lt;lgl&gt;  &lt;chr&gt;        &lt;chr&gt;    &lt;dbl&gt;
## 1     2 FALSE FALSE  good         Matilda     7.
## 2     3 FALSE TRUE   satisfactory Nicholas    5.
## 3     4 TRUE  FALSE  poor         Olivia      3.
## 4     5 TRUE  TRUE   fail         Paul        1.</code></pre>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidy-formatted-cells.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="already-a-tidy-table-but-with-text-sentinel-values-in-non-text-columns.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
