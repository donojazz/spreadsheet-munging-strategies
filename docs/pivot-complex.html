<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Spreadsheet Munging Strategies</title>
  <meta name="description" content="Spreadsheet Munging Strategies">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Spreadsheet Munging Strategies" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Spreadsheet Munging Strategies" />
  
  
  

<meta name="author" content="Duncan Garmonsway">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="pivot-simple.html">
<link rel="next" href="small-multiples.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-45097885-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-45097885-10');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidyish.html"><a href="tidyish.html"><i class="fa fa-check"></i><b>2</b> Tidy-ish tables</a><ul>
<li class="chapter" data-level="2.1" data-path="tidy-clean.html"><a href="tidy-clean.html"><i class="fa fa-check"></i><b>2.1</b> Clean &amp; tidy tables</a></li>
<li class="chapter" data-level="2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html"><i class="fa fa-check"></i><b>2.2</b> Almost-tidy tables</a><ul>
<li class="chapter" data-level="2.2.1" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#transposed-headers-in-the-first-row-data-extends-to-the-right"><i class="fa fa-check"></i><b>2.2.1</b> Transposed (headers in the first row, data extends to the right)</a></li>
<li class="chapter" data-level="2.2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#other-stuff-on-the-same-sheet"><i class="fa fa-check"></i><b>2.2.2</b> Other stuff on the same sheet</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="tidy-formatted-rows.html"><a href="tidy-formatted-rows.html"><i class="fa fa-check"></i><b>2.3</b> Meaningfully formatted rows</a></li>
<li class="chapter" data-level="2.4" data-path="tidy-formatted-cells.html"><a href="tidy-formatted-cells.html"><i class="fa fa-check"></i><b>2.4</b> Meaningfully formatted cells</a></li>
<li class="chapter" data-level="2.5" data-path="layered-formatting.html"><a href="layered-formatting.html"><i class="fa fa-check"></i><b>2.5</b> Layered meaningful formatting</a></li>
<li class="chapter" data-level="2.6" data-path="hierarchies-in-formatting.html"><a href="hierarchies-in-formatting.html"><i class="fa fa-check"></i><b>2.6</b> Hierarchies in formatting</a></li>
<li class="chapter" data-level="2.7" data-path="tidy-sentinel.html"><a href="tidy-sentinel.html"><i class="fa fa-check"></i><b>2.7</b> Sentinel values in non-text columns</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="pivot.html"><a href="pivot.html"><i class="fa fa-check"></i><b>3</b> Pivot tables</a><ul>
<li class="chapter" data-level="3.1" data-path="pivot-simple.html"><a href="pivot-simple.html"><i class="fa fa-check"></i><b>3.1</b> Simple unpivoting</a><ul>
<li class="chapter" data-level="3.1.1" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-of-text-column-headers-left-aligned"><i class="fa fa-check"></i><b>3.1.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.1.2" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned"><i class="fa fa-check"></i><b>3.1.2</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.1.3" data-path="pivot-simple.html"><a href="pivot-simple.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting"><i class="fa fa-check"></i><b>3.1.3</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="pivot-complex.html"><a href="pivot-complex.html"><i class="fa fa-check"></i><b>3.2</b> Complex unpivoting</a><ul>
<li class="chapter" data-level="3.2.1" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-of-text-column-headers-left-aligned-1"><i class="fa fa-check"></i><b>3.2.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.2.2" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-columns-of-text-row-headers-top-aligned"><i class="fa fa-check"></i><b>3.2.2</b> Two clear columns of text row headers, top-aligned</a></li>
<li class="chapter" data-level="3.2.3" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1"><i class="fa fa-check"></i><b>3.2.3</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.2.4" data-path="pivot-complex.html"><a href="pivot-complex.html#centre-aligned-headers"><i class="fa fa-check"></i><b>3.2.4</b> Centre-aligned headers</a></li>
<li class="chapter" data-level="3.2.5" data-path="pivot-complex.html"><a href="pivot-complex.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting-1"><i class="fa fa-check"></i><b>3.2.5</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
<li class="chapter" data-level="3.2.6" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.2.6</b> Mixed headers and notes in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.7" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.2.7</b> Mixed levels of headers in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.8" data-path="pivot-complex.html"><a href="pivot-complex.html#repeated-rowscolumns-of-headers-within-the-table"><i class="fa fa-check"></i><b>3.2.8</b> Repeated rows/columns of headers within the table</a></li>
<li class="chapter" data-level="3.2.9" data-path="pivot-complex.html"><a href="pivot-complex.html#headers-amongst-the-data"><i class="fa fa-check"></i><b>3.2.9</b> Headers amongst the data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="small-multiples.html"><a href="small-multiples.html"><i class="fa fa-check"></i><b>4</b> Small multiples</a><ul>
<li class="chapter" data-level="4.1" data-path="small-multiples-with-all-headers-present-for-each-multiple.html"><a href="small-multiples-with-all-headers-present-for-each-multiple.html"><i class="fa fa-check"></i><b>4.1</b> Small multiples with all headers present for each multiple</a></li>
<li class="chapter" data-level="4.2" data-path="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><a href="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><i class="fa fa-check"></i><b>4.2</b> Same table in several worksheets/files (using the sheet/file name)</a></li>
<li class="chapter" data-level="4.3" data-path="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><a href="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><i class="fa fa-check"></i><b>4.3</b> Same table in several worksheets/files but in different positions</a></li>
<li class="chapter" data-level="4.4" data-path="implied-multiples.html"><a href="implied-multiples.html"><i class="fa fa-check"></i><b>4.4</b> Implied multiples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="formatting.html"><a href="formatting.html"><i class="fa fa-check"></i><b>5</b> Formatting</a><ul>
<li class="chapter" data-level="5.1" data-path="an-example-formatting-lookup.html"><a href="an-example-formatting-lookup.html"><i class="fa fa-check"></i><b>5.1</b> An example formatting lookup</a></li>
<li class="chapter" data-level="5.2" data-path="common-formats.html"><a href="common-formats.html"><i class="fa fa-check"></i><b>5.2</b> Common formats</a></li>
<li class="chapter" data-level="5.3" data-path="in-cell-formatting.html"><a href="in-cell-formatting.html"><i class="fa fa-check"></i><b>5.3</b> In-cell formatting</a></li>
<li class="chapter" data-level="5.4" data-path="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><a href="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><i class="fa fa-check"></i><b>5.4</b> Multiple pieces of information in a single cell, with meaningful formatting</a></li>
<li class="chapter" data-level="5.5" data-path="superscript-symbols.html"><a href="superscript-symbols.html"><i class="fa fa-check"></i><b>5.5</b> Superscript symbols</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-validation.html"><a href="data-validation.html"><i class="fa fa-check"></i><b>6</b> Data validation</a></li>
<li class="chapter" data-level="7" data-path="formulas.html"><a href="formulas.html"><i class="fa fa-check"></i><b>7</b> Formulas</a></li>
<li class="chapter" data-level="8" data-path="other-gotchas.html"><a href="other-gotchas.html"><i class="fa fa-check"></i><b>8</b> Other gotchas</a><ul>
<li class="chapter" data-level="8.1" data-path="non-text-headers-e-g-dates.html"><a href="non-text-headers-e-g-dates.html"><i class="fa fa-check"></i><b>8.1</b> Non-text headers e.g. dates</a></li>
<li class="chapter" data-level="8.2" data-path="data-embedded-in-comments.html"><a href="data-embedded-in-comments.html"><i class="fa fa-check"></i><b>8.2</b> Data embedded in comments</a></li>
<li class="chapter" data-level="8.3" data-path="named-ranges.html"><a href="named-ranges.html"><i class="fa fa-check"></i><b>8.3</b> Named ranges</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="case-studies.html"><a href="case-studies.html"><i class="fa fa-check"></i><b>9</b> Case studies</a><ul>
<li class="chapter" data-level="9.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html"><i class="fa fa-check"></i><b>9.1</b> Australian Marriage Survey</a><ul>
<li class="chapter" data-level="9.1.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#the-full-code-listing"><i class="fa fa-check"></i><b>9.1.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.1.2" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#step-by-step"><i class="fa fa-check"></i><b>9.1.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="vaccinations.html"><a href="vaccinations.html"><i class="fa fa-check"></i><b>9.2</b> Vaccinations</a></li>
<li class="chapter" data-level="9.3" data-path="us-crime.html"><a href="us-crime.html"><i class="fa fa-check"></i><b>9.3</b> US Crime</a><ul>
<li class="chapter" data-level="9.3.1" data-path="us-crime.html"><a href="us-crime.html#us-crime-2"><i class="fa fa-check"></i><b>9.3.1</b> Table 2</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html"><i class="fa fa-check"></i><b>9.4</b> Toronto Transit Commission</a><ul>
<li class="chapter" data-level="9.4.1" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#the-full-code-listing-1"><i class="fa fa-check"></i><b>9.4.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.4.2" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#step-by-step-1"><i class="fa fa-check"></i><b>9.4.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="ground-water.html"><a href="ground-water.html"><i class="fa fa-check"></i><b>9.5</b> Ground water</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spreadsheet Munging Strategies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pivot-complex" class="section level2">
<h2><span class="header-section-number">3.2</span> Complex unpivoting</h2>
<p>When <code>behead()</code> isn’t powerful enough (it makes certain assumptions, and it
doesn’t understand formatting), then you can get much more control by using
<code>enhead()</code>, which joins together two separate data frames of data cells and
header cells.</p>
<p>This kind of unpivoting is always done in two stages.</p>
<ol style="list-style-type: decimal">
<li>Identify which cells are headers, and which are data</li>
<li>State how the data cells relate to the header cells.</li>
</ol>
<div id="two-clear-rows-of-text-column-headers-left-aligned-1" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Two clear rows of text column headers, left-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>The first stage, identifying header vs data cells, is simply filtering.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb119-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb119-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb119-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, <span class="op">!</span>is_blank) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Ignore the row headers in this example</span></a>
<a class="sourceLine" id="cb119-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb119-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 22 x 5
##      row   col data_type character numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
##  1     2     4 character Female         NA
##  2     2     6 character Male           NA
##  3     3     4 character Matilda        NA
##  4     3     5 character Olivia         NA
##  5     3     6 character Nicholas       NA
##  6     3     7 character Paul           NA
##  7     4     4 numeric   &lt;NA&gt;            1
##  8     4     5 numeric   &lt;NA&gt;            2
##  9     4     6 numeric   &lt;NA&gt;            3
## 10     4     7 numeric   &lt;NA&gt;            0
## # ... with 12 more rows</code></pre>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb121-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   `row/col` `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         2 Female  &lt;NA&gt;   Male     &lt;NA&gt;  
## 2         3 Matilda Olivia Nicholas Paul  
## 3         4 1       2      3        0     
## 4         5 3       4      5        1     
## 5         6 5       6      9        2     
## 6         7 7       8      12       3</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb123-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb123-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb123-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb123-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb123-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb123-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb125-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb125-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb125-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb125-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb125-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Matilda 
## 2     3     5 Olivia  
## 3     3     6 Nicholas
## 4     3     7 Paul</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb127-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb127-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb127-4" data-line-number="4">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb127-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb127-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb127-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a></code></pre></div>
<p>The second stage is to declare how the data cells relate to each row of column
headers. Unpivotr provides a set of functions for this, derived from the points
of the compass.</p>
<p>Starting from the point of view of a data cell, the relevant column header from
the second row of headers is the one directly north (up), or <code>&quot;N&quot;</code>.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1"><span class="kw">enhead</span>(data_cells, second_header_row, <span class="st">&quot;N&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 4
##      row   col score name    
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   
##  1     4     4     1 Matilda 
##  2     4     5     2 Olivia  
##  3     4     6     3 Nicholas
##  4     4     7     0 Paul    
##  5     5     4     3 Matilda 
##  6     5     5     4 Olivia  
##  7     5     6     5 Nicholas
##  8     5     7     1 Paul    
##  9     6     4     5 Matilda 
## 10     6     5     6 Olivia  
## 11     6     6     9 Nicholas
## 12     6     7     2 Paul    
## 13     7     4     7 Matilda 
## 14     7     5     8 Olivia  
## 15     7     6    12 Nicholas
## 16     7     7     3 Paul</code></pre>
<p>The first row of headers, from the point of view of a data cell, is either
directly north (up), or north and west (up and left), or <code>&quot;NNW&quot;</code>.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" data-line-number="1"><span class="kw">enhead</span>(data_cells, first_header_row, <span class="st">&quot;NNW&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 4
##      row   col score sex   
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; 
##  1     4     4     1 Female
##  2     4     5     2 Female
##  3     5     4     3 Female
##  4     5     5     4 Female
##  5     6     4     5 Female
##  6     6     5     6 Female
##  7     7     4     7 Female
##  8     7     5     8 Female
##  9     4     6     3 Male  
## 10     4     7     0 Male  
## 11     5     6     5 Male  
## 12     5     7     1 Male  
## 13     6     6     9 Male  
## 14     6     7     2 Male  
## 15     7     6    12 Male  
## 16     7     7     3 Male</code></pre>
<p>Piping everything together, we get a complete, tidy dataset, and can finally
drop the <code>row</code> and <code>col</code> columns.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" data-line-number="1">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb132-2" data-line-number="2"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb132-3" data-line-number="3"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb132-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score sex    name    
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   
##  1     1 Female Matilda 
##  2     2 Female Olivia  
##  3     3 Female Matilda 
##  4     4 Female Olivia  
##  5     5 Female Matilda 
##  6     6 Female Olivia  
##  7     7 Female Matilda 
##  8     8 Female Olivia  
##  9     3 Male   Nicholas
## 10     0 Male   Paul    
## 11     5 Male   Nicholas
## 12     1 Male   Paul    
## 13     9 Male   Nicholas
## 14     2 Male   Paul    
## 15    12 Male   Nicholas
## 16     3 Male   Paul</code></pre>
</div>
<div id="two-clear-columns-of-text-row-headers-top-aligned" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Two clear columns of text row headers, top-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is almost the same as <a href="2RL">Two clear rows of text column headers,
left-aligned</a>, but with different compass directions: <code>&quot;W&quot;</code> for directly
west (left), and <code>&quot;WNW&quot;</code> for west and north (left and up).</p>
<p>(<code>&quot;NNW&quot;</code> and <code>&quot;WNW&quot;</code> look like synonyms. They happen to be synonyms in
<code>enhead()</code>, but they aren’t in <code>behead()</code>.</p>
<p>In this example, the table has no column headers, only row headers. This is
artificial here, but sometimes table are deliberately laid out in transpose
form: the first column contains the headers, and the data extends in columns
from left to right instead of from top to bottom.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb134-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb134-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">3</span>, <span class="op">!</span>is_blank) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Ignore the column headers in this example</span></a>
<a class="sourceLine" id="cb134-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 26 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     3     4 character Matilda         NA
##  2     3     5 character Olivia          NA
##  3     3     6 character Nicholas        NA
##  4     3     7 character Paul            NA
##  5     4     2 character Humanities      NA
##  6     4     3 character Classics        NA
##  7     4     4 numeric   &lt;NA&gt;             1
##  8     4     5 numeric   &lt;NA&gt;             2
##  9     4     6 numeric   &lt;NA&gt;             3
## 10     4     7 numeric   &lt;NA&gt;             0
## # ... with 16 more rows</code></pre>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 5 x 7
##   `row/col` `2(B)`      `3(C)`   `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         3 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul  
## 2         4 Humanities  Classics 1       2      3        0     
## 3         5 &lt;NA&gt;        History  3       4      5        1     
## 4         6 Performance Music    5       6      9        2     
## 5         7 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb138-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb138-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb138-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb138-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb138-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb138-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb140-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb140-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb140-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb140-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb140-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb140-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     3 Classics
## 2     5     3 History 
## 3     6     3 Music   
## 4     7     3 Drama</code></pre>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb142-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb142-4" data-line-number="4">  <span class="co"># The data is examp scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb142-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb142-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb142-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb142-8" data-line-number="8"></a>
<a class="sourceLine" id="cb142-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score field       subject 
##    &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;   
##  1     1 Humanities  Classics
##  2     2 Humanities  Classics
##  3     3 Humanities  Classics
##  4     0 Humanities  Classics
##  5     3 Humanities  History 
##  6     4 Humanities  History 
##  7     5 Humanities  History 
##  8     1 Humanities  History 
##  9     5 Performance Music   
## 10     6 Performance Music   
## 11     9 Performance Music   
## 12     2 Performance Music   
## 13     7 Performance Drama   
## 14     8 Performance Drama   
## 15    12 Performance Drama   
## 16     3 Performance Drama</code></pre>
</div>
<div id="two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1" class="section level3">
<h3><span class="header-section-number">3.2.3</span> Two clear rows and columns of text headers, top-aligned and left-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is a combination of the previous two sections. No new techniques are used.</p>
<ol style="list-style-type: decimal">
<li>Identify which cells are headers, and which are data</li>
<li>State how the data cells relate to the header cells.</li>
</ol>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb144-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb144-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb144-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb144-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb144-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb144-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 28 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     4 character Female          NA
##  2     2     6 character Male            NA
##  3     3     4 character Matilda         NA
##  4     3     5 character Olivia          NA
##  5     3     6 character Nicholas        NA
##  6     3     7 character Paul            NA
##  7     4     2 character Humanities      NA
##  8     4     3 character Classics        NA
##  9     4     4 numeric   &lt;NA&gt;             1
## 10     4     5 numeric   &lt;NA&gt;             2
## # ... with 18 more rows</code></pre>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb146-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb146-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   `row/col` `2(B)`      `3(C)`   `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         2 &lt;NA&gt;        &lt;NA&gt;     Female  &lt;NA&gt;   Male     &lt;NA&gt;  
## 2         3 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul  
## 3         4 Humanities  Classics 1       2      3        0     
## 4         5 &lt;NA&gt;        History  3       4      5        1     
## 5         6 Performance Music    5       6      9        2     
## 6         7 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb148-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb148-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb148-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb148-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb148-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb148-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb148-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb150-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb150-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb150-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb150-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb150-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb150-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Matilda 
## 2     3     5 Olivia  
## 3     3     6 Nicholas
## 4     3     7 Paul</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb152-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb152-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb152-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb152-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb152-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb152-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb154-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb154-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb154-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb154-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb154-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb154-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb154-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     3 Classics
## 2     5     3 History 
## 3     6     3 Music   
## 4     7     3 Drama</code></pre>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb156-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb156-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb156-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb156-4" data-line-number="4">  <span class="co"># The data is examp scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb156-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb156-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb156-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb156-8" data-line-number="8"></a>
<a class="sourceLine" id="cb156-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb156-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb156-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb156-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb156-13" data-line-number="13"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb156-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 5
##    score sex    name     field       subject 
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;   
##  1     1 Female Matilda  Humanities  Classics
##  2     2 Female Olivia   Humanities  Classics
##  3     3 Female Matilda  Humanities  History 
##  4     4 Female Olivia   Humanities  History 
##  5     3 Male   Nicholas Humanities  Classics
##  6     0 Male   Paul     Humanities  Classics
##  7     5 Male   Nicholas Humanities  History 
##  8     1 Male   Paul     Humanities  History 
##  9     5 Female Matilda  Performance Music   
## 10     6 Female Olivia   Performance Music   
## 11     7 Female Matilda  Performance Drama   
## 12     8 Female Olivia   Performance Drama   
## 13     9 Male   Nicholas Performance Music   
## 14     2 Male   Paul     Performance Music   
## 15    12 Male   Nicholas Performance Drama   
## 16     3 Male   Paul     Performance Drama</code></pre>
</div>
<div id="centre-aligned-headers" class="section level3">
<h3><span class="header-section-number">3.2.4</span> Centre-aligned headers</h3>
<p><img src="images/pivot-centre-aligned.png" /></p>
<p>Headers aren’t always aligned to one side of the data cells that they describe.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb158-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb158-2" data-line-number="2">all_cells &lt;-<span class="st"> </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-centre-aligned&quot;</span>)</a>
<a class="sourceLine" id="cb158-3" data-line-number="3"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 10
##    `row/col` `2(B)`    `3(C)`   `4(D)` `5(E)` `6(F)` `7(G)` `8(H)` `9(I)` 
##        &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  
##  1         2 &lt;NA&gt;      &lt;NA&gt;     &lt;NA&gt;   Female &lt;NA&gt;   &lt;NA&gt;   &lt;NA&gt;   Male   
##  2         3 &lt;NA&gt;      &lt;NA&gt;     Leah   Matil… Olivia Lenny  Max    Nichol…
##  3         4 &lt;NA&gt;      Classics 3      1      2      4      3      3      
##  4         5 Humaniti… History  8      3      4      7      5      5      
##  5         6 &lt;NA&gt;      Literat… 1      1      9      3      12     7      
##  6         7 &lt;NA&gt;      Philoso… 5      10     10     8      2      5      
##  7         8 &lt;NA&gt;      Languag… 5      4      5      9      8      3      
##  8         9 &lt;NA&gt;      Music    4      10     10     2      4      5      
##  9        10 Performa… Dance    4      5      6      4      12     9      
## 10        11 &lt;NA&gt;      Drama    2      7      8      6      1      12     
## # ... with 1 more variable: `10(J)` &lt;chr&gt;</code></pre>
<p>Looking at that table, it’s not immediately obvious where the boundary between
<code>Female</code> and <code>Male</code> falls, or between <code>Humanities</code> and <code>Performance</code>. A naive
approach would be to match the inner headers to the outer ones by proximity, and
there are four directions to do so: <code>&quot;ABOVE&quot;</code>, <code>&quot;LEFT&quot;</code>, <code>&quot;BELOW&quot;</code>, and
<code>&quot;RIGHT&quot;</code>.</p>
<p>But in this case, those directions are too naive.</p>
<ul>
<li><code>Languages</code> is closest to the <code>Performance</code> header, but is a humanity.</li>
<li><code>Lenny</code> is the same distance from <code>Female</code> as from <code>Male</code>.</li>
</ul>
<p>You can fix this by justifying the header cells towards one side of the data
cells that they describe, and then use a direction like <code>&quot;NNW&quot;</code> as usual. Do
this with <code>justify()</code>, providing the header cells with a second set of cells
at the positions you want the header cells to move to.</p>
<ul>
<li><code>header_cells</code> is the cells whose value will be used as the header</li>
<li><code>corner_cells</code> is the cells whose position is in one corner of the domain of
the header (e.g. the top-left-hand corner).</li>
</ul>
<p>In the original spreadsheet, the borders mark the boundaries. So the corner
cells of the headers can be found by filtering for cells with a particular
border.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb160-1" data-line-number="1">all_cells &lt;-</a>
<a class="sourceLine" id="cb160-2" data-line-number="2"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-centre-aligned&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb160-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, is_blank, data_type, character, numeric, local_format_id)</a>
<a class="sourceLine" id="cb160-4" data-line-number="4"></a>
<a class="sourceLine" id="cb160-5" data-line-number="5">formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)</a>
<a class="sourceLine" id="cb160-6" data-line-number="6">top_borders &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(formats<span class="op">$</span>local<span class="op">$</span>border<span class="op">$</span>top<span class="op">$</span>style))</a>
<a class="sourceLine" id="cb160-7" data-line-number="7">left_borders &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(formats<span class="op">$</span>local<span class="op">$</span>border<span class="op">$</span>left<span class="op">$</span>style))</a>
<a class="sourceLine" id="cb160-8" data-line-number="8"></a>
<a class="sourceLine" id="cb160-9" data-line-number="9">first_header_row_corners &lt;-</a>
<a class="sourceLine" id="cb160-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>left_borders) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb160-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(row, col)</a>
<a class="sourceLine" id="cb160-12" data-line-number="12">first_header_row_corners</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##     row   col
##   &lt;int&gt; &lt;int&gt;
## 1     2     4
## 2     2     7</code></pre>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb162-1" data-line-number="1">first_header_col_corners &lt;-</a>
<a class="sourceLine" id="cb162-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>top_borders) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb162-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col)</a>
<a class="sourceLine" id="cb162-4" data-line-number="4">first_header_col_corners</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##     row   col
##   &lt;int&gt; &lt;int&gt;
## 1     4     2
## 2     9     2</code></pre>
<p>Next, get the first row and first column of header cells as usual.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb164-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb164-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, <span class="op">!</span>is_blank, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb164-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb164-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb164-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb164-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb164-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     5 Female
## 2     2     9 Male</code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb166-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb166-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, <span class="op">!</span>is_blank, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb166-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb166-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb166-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb166-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb166-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     5     2 Humanities 
## 2    10     2 Performance</code></pre>
<p>And now justify the header cells to the same positions as the corner cells.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" data-line-number="1">first_header_row &lt;-<span class="st"> </span><span class="kw">justify</span>(first_header_row, first_header_row_corners)</a>
<a class="sourceLine" id="cb168-2" data-line-number="2">first_header_col &lt;-<span class="st"> </span><span class="kw">justify</span>(first_header_col, first_header_col_corners)</a>
<a class="sourceLine" id="cb168-3" data-line-number="3"></a>
<a class="sourceLine" id="cb168-4" data-line-number="4">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     7 Male</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" data-line-number="1">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     9     2 Performance</code></pre>
<p>The rest of this example is the same as “Two clear rows and columns of text
headers, top-aligned and left-aligned”.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb172-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb172-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb172-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb172-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb172-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb172-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 7 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Leah    
## 2     3     5 Matilda 
## 3     3     6 Olivia  
## 4     3     7 Lenny   
## 5     3     8 Max     
## 6     3     9 Nicholas
## 7     3    10 Paul</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb174-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb174-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb174-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb174-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb174-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb174-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb174-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 8 x 3
##     row   col subject   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;     
## 1     4     3 Classics  
## 2     5     3 History   
## 3     6     3 Literature
## 4     7     3 Philosophy
## 5     8     3 Languages 
## 6     9     3 Music     
## 7    10     3 Dance     
## 8    11     3 Drama</code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb176-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb176-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb176-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb176-4" data-line-number="4">  <span class="co"># The data is examp scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb176-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb176-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb176-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb176-8" data-line-number="8"></a>
<a class="sourceLine" id="cb176-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb176-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb176-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb176-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb176-13" data-line-number="13"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb176-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 56 x 5
##    score sex    name    field      subject   
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;     
##  1     3 Female Leah    Humanities Classics  
##  2     1 Female Matilda Humanities Classics  
##  3     2 Female Olivia  Humanities Classics  
##  4     8 Female Leah    Humanities History   
##  5     3 Female Matilda Humanities History   
##  6     4 Female Olivia  Humanities History   
##  7     1 Female Leah    Humanities Literature
##  8     1 Female Matilda Humanities Literature
##  9     9 Female Olivia  Humanities Literature
## 10     5 Female Leah    Humanities Philosophy
## # ... with 46 more rows</code></pre>
</div>
<div id="multiple-rows-or-columns-of-headers-with-meaningful-formatting-1" class="section level3">
<h3><span class="header-section-number">3.2.5</span> Multiple rows or columns of headers, with meaningful formatting</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is a combination of the previous section with <a href="tidy-formatted-cells">Meaningfully formatted
cells</a>. The section <a href="tidy-formatted-rows">Meaningfully formatted
rows</a> doesn’t work here, because the unpivoting of multiple
rows/columns of headers complicates the relationship between the data and the
formatting.</p>
<ol style="list-style-type: decimal">
<li>Unpivot the multiple rows/columns of headers, as above, but keep the <code>row</code>
and <code>col</code> of each data cell.</li>
<li>Collect the <code>row</code>, <code>col</code> and formatting of each data cell.</li>
<li>Join the data to the formatting by the <code>row</code> and <code>col</code>.</li>
</ol>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb178-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb178-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb178-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb178-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb178-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb178-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 28 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     4 character Female          NA
##  2     2     6 character Male            NA
##  3     3     4 character Matilda         NA
##  4     3     5 character Olivia          NA
##  5     3     6 character Nicholas        NA
##  6     3     7 character Paul            NA
##  7     4     2 character Humanities      NA
##  8     4     3 character Classics        NA
##  9     4     4 numeric   &lt;NA&gt;             1
## 10     4     5 numeric   &lt;NA&gt;             2
## # ... with 18 more rows</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb180-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb180-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   `row/col` `2(B)`      `3(C)`   `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         2 &lt;NA&gt;        &lt;NA&gt;     Female  &lt;NA&gt;   Male     &lt;NA&gt;  
## 2         3 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul  
## 3         4 Humanities  Classics 1       2      3        0     
## 4         5 &lt;NA&gt;        History  3       4      5        1     
## 5         6 Performance Music    5       6      9        2     
## 6         7 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb182-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb182-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb182-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb182-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb182-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb182-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb182-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb184-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb184-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb184-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb184-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb184-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb184-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Matilda 
## 2     3     5 Olivia  
## 3     3     6 Nicholas
## 4     3     7 Paul</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb186-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb186-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb186-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb186-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb186-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb186-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb186-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb188-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb188-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb188-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb188-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb188-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb188-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb188-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     3 Classics
## 2     5     3 History 
## 3     6     3 Music   
## 4     7     3 Drama</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb190-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb190-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb190-4" data-line-number="4">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb190-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb190-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb190-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb190-8" data-line-number="8"></a>
<a class="sourceLine" id="cb190-9" data-line-number="9">unpivoted &lt;-</a>
<a class="sourceLine" id="cb190-10" data-line-number="10"><span class="st">  </span>data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-13" data-line-number="13"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-14" data-line-number="14"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb190-15" data-line-number="15">  <span class="co"># Don&#39;t delet the `row` and `col` columns yet, because we need them to join on</span></a>
<a class="sourceLine" id="cb190-16" data-line-number="16">  <span class="co"># the formatting</span></a>
<a class="sourceLine" id="cb190-17" data-line-number="17"></a>
<a class="sourceLine" id="cb190-18" data-line-number="18"><span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span></a>
<a class="sourceLine" id="cb190-19" data-line-number="19"><span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span></a>
<a class="sourceLine" id="cb190-20" data-line-number="20">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb190-21" data-line-number="21"></a>
<a class="sourceLine" id="cb190-22" data-line-number="22"><span class="co"># Import all the cells, filter out the header row, filter for the first column,</span></a>
<a class="sourceLine" id="cb190-23" data-line-number="23"><span class="co"># and create a new column `approximate` based on the fill colours, by looking up</span></a>
<a class="sourceLine" id="cb190-24" data-line-number="24"><span class="co"># the local_format_id of each cell in the `formats` pallette.</span></a>
<a class="sourceLine" id="cb190-25" data-line-number="25">annotations &lt;-</a>
<a class="sourceLine" id="cb190-26" data-line-number="26"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-27" data-line-number="27"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the headers</span></a>
<a class="sourceLine" id="cb190-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb190-29" data-line-number="29"><span class="st">  </span><span class="kw">select</span>(row, col, fill_colour)</a>
<a class="sourceLine" id="cb190-30" data-line-number="30">annotations</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col fill_colour
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
##  1     4     4 &lt;NA&gt;       
##  2     4     5 FFFFFF00   
##  3     4     6 &lt;NA&gt;       
##  4     4     7 &lt;NA&gt;       
##  5     5     4 FFFFFF00   
##  6     5     5 &lt;NA&gt;       
##  7     5     6 &lt;NA&gt;       
##  8     5     7 &lt;NA&gt;       
##  9     6     4 &lt;NA&gt;       
## 10     6     5 &lt;NA&gt;       
## 11     6     6 &lt;NA&gt;       
## 12     6     7 &lt;NA&gt;       
## 13     7     4 &lt;NA&gt;       
## 14     7     5 &lt;NA&gt;       
## 15     7     6 FFFFFF00   
## 16     7     7 &lt;NA&gt;</code></pre>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb192-1" data-line-number="1"><span class="kw">left_join</span>(unpivoted, annotations, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb192-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 6
##    score sex    name     field       subject  fill_colour
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;      
##  1     1 Female Matilda  Humanities  Classics &lt;NA&gt;       
##  2     2 Female Olivia   Humanities  Classics FFFFFF00   
##  3     3 Female Matilda  Humanities  History  FFFFFF00   
##  4     4 Female Olivia   Humanities  History  &lt;NA&gt;       
##  5     3 Male   Nicholas Humanities  Classics &lt;NA&gt;       
##  6     0 Male   Paul     Humanities  Classics &lt;NA&gt;       
##  7     5 Male   Nicholas Humanities  History  &lt;NA&gt;       
##  8     1 Male   Paul     Humanities  History  &lt;NA&gt;       
##  9     5 Female Matilda  Performance Music    &lt;NA&gt;       
## 10     6 Female Olivia   Performance Music    &lt;NA&gt;       
## 11     7 Female Matilda  Performance Drama    &lt;NA&gt;       
## 12     8 Female Olivia   Performance Drama    &lt;NA&gt;       
## 13     9 Male   Nicholas Performance Music    &lt;NA&gt;       
## 14     2 Male   Paul     Performance Music    &lt;NA&gt;       
## 15    12 Male   Nicholas Performance Drama    FFFFFF00   
## 16     3 Male   Paul     Performance Drama    &lt;NA&gt;</code></pre>
</div>
<div id="mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting" class="section level3">
<h3><span class="header-section-number">3.2.6</span> Mixed headers and notes in the same row/column, distinguished by formatting</h3>
<p><img src="images/pivot-notes.png" /></p>
<p>This doesn’t use any new techniques. The trick is, when selecting a row or
column of header cells, to filter out ones that have the ‘wrong’ formatting
(formatting that shows they aren’t really headers). In this example, cells with
italic or red text aren’t headers, even if they are in amongst header cells.</p>
<p>First, identify the IDs of formats that have italic or red text.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb194-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb194-2" data-line-number="2">formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)</a>
<a class="sourceLine" id="cb194-3" data-line-number="3"></a>
<a class="sourceLine" id="cb194-4" data-line-number="4">italic &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>italic)</a>
<a class="sourceLine" id="cb194-5" data-line-number="5"></a>
<a class="sourceLine" id="cb194-6" data-line-number="6"><span class="co"># For &#39;red&#39; we can either look for the RGB code for red &quot;FFFF0000&quot;</span></a>
<a class="sourceLine" id="cb194-7" data-line-number="7">red &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb <span class="op">==</span><span class="st"> &quot;FFFF0000&quot;</span>)</a>
<a class="sourceLine" id="cb194-8" data-line-number="8">red</a></code></pre></div>
<pre><code>## [1] 12 13 14 40 41</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb196-1" data-line-number="1"><span class="co"># Or we can find out what that code is by starting from a cell that we know is</span></a>
<a class="sourceLine" id="cb196-2" data-line-number="2"><span class="co"># red.</span></a>
<a class="sourceLine" id="cb196-3" data-line-number="3">red_cell_format_id &lt;-</a>
<a class="sourceLine" id="cb196-4" data-line-number="4"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-notes&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb196-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">==</span><span class="st"> </span><span class="dv">5</span>, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb196-6" data-line-number="6"><span class="st">  </span><span class="kw">pull</span>(local_format_id)</a>
<a class="sourceLine" id="cb196-7" data-line-number="7">red_cell_format_id</a></code></pre></div>
<pre><code>## [1] 40</code></pre>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb198-1" data-line-number="1">red_rgb &lt;-<span class="st"> </span>formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb[red_cell_format_id]</a>
<a class="sourceLine" id="cb198-2" data-line-number="2">red &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb <span class="op">==</span><span class="st"> </span>red_rgb)</a>
<a class="sourceLine" id="cb198-3" data-line-number="3">red</a></code></pre></div>
<pre><code>## [1] 12 13 14 40 41</code></pre>
<p>Now we select the headers, filtering out cells with the format IDs of red or
italic cells.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb200-1" data-line-number="1">all_cells &lt;-</a>
<a class="sourceLine" id="cb200-2" data-line-number="2"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-notes&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, character, numeric, local_format_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb200-5" data-line-number="5"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 31 x 5
##      row   col character  numeric local_format_id
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;        &lt;dbl&gt;           &lt;int&gt;
##  1     2     4 Female          NA              18
##  2     2     6 Male            NA              18
##  3     2     7 0 = absent      NA              39
##  4     3     4 Matilda         NA              20
##  5     3     5 Olivia          NA              21
##  6     3     6 Nicholas        NA              20
##  7     3     7 Paul            NA              21
##  8     4     2 Humanities      NA              18
##  9     4     3 Classics        NA              19
## 10     4     4 &lt;NA&gt;             1              33
## # ... with 21 more rows</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb202-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb202-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, <span class="op">!</span>(local_format_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(red, italic))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb202-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb202-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb202-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb202-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb202-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb204-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb204-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, <span class="op">!</span>(local_format_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(red, italic))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb204-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">qualification =</span> character)</a>
<a class="sourceLine" id="cb204-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb204-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb204-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb204-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col qualification
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;        
## 1     4     2 Humanities   
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb206-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb206-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb206-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb206-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb206-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb206-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb206-7" data-line-number="7"></a>
<a class="sourceLine" id="cb206-8" data-line-number="8">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb206-9" data-line-number="9"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb206-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb206-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score sex    qualification
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;        
##  1     1 Female Humanities   
##  2     2 Female Humanities   
##  3     3 Female Humanities   
##  4     4 Female Humanities   
##  5     3 Male   Humanities   
##  6     0 Male   Humanities   
##  7     5 Male   Humanities   
##  8     1 Male   Humanities   
##  9     5 Female Performance  
## 10     6 Female Performance  
## 11     7 Female Performance  
## 12     8 Female Performance  
## 13     9 Male   Performance  
## 14     2 Male   Performance  
## 15    12 Male   Performance  
## 16     3 Male   Performance</code></pre>
</div>
<div id="mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting" class="section level3">
<h3><span class="header-section-number">3.2.7</span> Mixed levels of headers in the same row/column, distinguished by formatting</h3>
<p><img src="images/pivot-hierarchy.png" /></p>
<p>Normally different levels of headers are in different rows, or different
columns, like <a href="2Rl">Two clear rows of text column headers, left-aligned</a>. But
sometimes they coexist in the same row or column, and are distinguishable by
formatting, e.g. bold for the top level, italic for the mid level, and plain for
the lowest level.</p>
<p>In this example, there is a single column of row headers, where the levels are
shown by different amounts of indentation. The indentation is done by
formatting, rather than by leading spaces or tabs.</p>
<p>The first step is to find the format IDs of all the different levels of
indentation.</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb208-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb208-2" data-line-number="2">formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)</a>
<a class="sourceLine" id="cb208-3" data-line-number="3"></a>
<a class="sourceLine" id="cb208-4" data-line-number="4">indent0 &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>alignment<span class="op">$</span>indent <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb208-5" data-line-number="5">indent1 &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>alignment<span class="op">$</span>indent <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb208-6" data-line-number="6"></a>
<a class="sourceLine" id="cb208-7" data-line-number="7">indent0</a></code></pre></div>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
## [24] 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 45 47 48
## [47] 49 50 51 52 53 54 55 56 57 58 59</code></pre>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb210-1" data-line-number="1">indent1</a></code></pre></div>
<pre><code>## [1] 44 46</code></pre>
<p>Now we use these format IDs to indentify the different levels of headers in the
first column.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb212-1" data-line-number="1">all_cells &lt;-</a>
<a class="sourceLine" id="cb212-2" data-line-number="2"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-hierarchy&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb212-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb212-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, local_format_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb212-5" data-line-number="5"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 16 x 6
##      row   col data_type character   numeric local_format_id
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt;           &lt;int&gt;
##  1     2     3 character Matilda          NA              18
##  2     2     4 character Nicholas         NA              42
##  3     3     2 character Humanities       NA              18
##  4     4     2 character Classics         NA              44
##  5     4     3 numeric   &lt;NA&gt;              1              20
##  6     4     4 numeric   &lt;NA&gt;              3              45
##  7     5     2 character History          NA              44
##  8     5     3 numeric   &lt;NA&gt;              3              20
##  9     5     4 numeric   &lt;NA&gt;              5              45
## 10     6     2 character Performance      NA              20
## 11     7     2 character Music            NA              44
## 12     7     3 numeric   &lt;NA&gt;              5              20
## 13     7     4 numeric   &lt;NA&gt;              9              45
## 14     8     2 character Drama            NA              46
## 15     8     3 numeric   &lt;NA&gt;              7              24
## 16     8     4 numeric   &lt;NA&gt;             12              47</code></pre>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb214-1" data-line-number="1">field &lt;-</a>
<a class="sourceLine" id="cb214-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>indent0) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb214-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb214-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb214-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb214-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb214-7" data-line-number="7">field</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     3     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb216-1" data-line-number="1">subject &lt;-</a>
<a class="sourceLine" id="cb216-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>indent1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb216-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb216-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb216-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb216-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb216-7" data-line-number="7">subject</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     2 Classics
## 2     5     2 History 
## 3     7     2 Music   
## 4     8     2 Drama</code></pre>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb218-1" data-line-number="1">name &lt;-</a>
<a class="sourceLine" id="cb218-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb218-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb218-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb218-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb218-6" data-line-number="6">name</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     2     3 Matilda 
## 2     2     4 Nicholas</code></pre>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb220-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb220-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb220-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb220-4" data-line-number="4">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb220-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb220-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb220-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb220-8" data-line-number="8"></a>
<a class="sourceLine" id="cb220-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb220-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(field, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb220-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(subject, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb220-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(name, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb220-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 8 x 4
##   score field       subject  name    
##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   
## 1     1 Humanities  Classics Matilda 
## 2     3 Humanities  Classics Nicholas
## 3     3 Humanities  History  Matilda 
## 4     5 Humanities  History  Nicholas
## 5     5 Performance Music    Matilda 
## 6     9 Performance Music    Nicholas
## 7     7 Performance Drama    Matilda 
## 8    12 Performance Drama    Nicholas</code></pre>
</div>
<div id="repeated-rowscolumns-of-headers-within-the-table" class="section level3">
<h3><span class="header-section-number">3.2.8</span> Repeated rows/columns of headers within the table</h3>
<p><img src="images/pivot-repeated-headers.png" /></p>
<p>Repetitions can simply be ignored. Select one of the sets of headers, and use
it for all the data. In this example, the data cells are easy to distinguish
from the headers mixed in among them, because only the data cells have the
<code>numeric</code> data type.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb222-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb222-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-repeated-headers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb222-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb222-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb222-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 80 x 5
##      row   col data_type character numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
##  1     2     4 character Term 1         NA
##  2     2     5 character Term 2         NA
##  3     2     6 character Term 3         NA
##  4     3     2 character Classics       NA
##  5     3     3 character Matilda        NA
##  6     3     4 numeric   &lt;NA&gt;            1
##  7     3     5 numeric   &lt;NA&gt;            8
##  8     3     6 numeric   &lt;NA&gt;            7
##  9     4     3 character Nicholas       NA
## 10     4     4 numeric   &lt;NA&gt;            3
## # ... with 70 more rows</code></pre>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb224-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb224-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 20 x 6
##    `row/col` `2(B)`   `3(C)`   `4(D)` `5(E)` `6(F)`
##        &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
##  1         2 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
##  2         3 Classics Matilda  1      8      7     
##  3         4 &lt;NA&gt;     Nicholas 3      1      2     
##  4         5 &lt;NA&gt;     Olivia   4      0      1     
##  5         6 &lt;NA&gt;     Paul     2      4      8     
##  6         7 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
##  7         8 History  Matilda  4      7      3     
##  8         9 &lt;NA&gt;     Nicholas 3      5      5     
##  9        10 &lt;NA&gt;     Olivia   9      8      5     
## 10        11 &lt;NA&gt;     Paul     6      2      0     
## 11        12 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
## 12        13 Music    Matilda  2      9      9     
## 13        14 &lt;NA&gt;     Nicholas 1      7      7     
## 14        15 &lt;NA&gt;     Olivia   0      3      5     
## 15        16 &lt;NA&gt;     Paul     2      2      3     
## 16        17 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
## 17        18 Drama    Matilda  9      8      9     
## 18        19 &lt;NA&gt;     Nicholas 1      3      4     
## 19        20 &lt;NA&gt;     Olivia   6      1      4     
## 20        21 &lt;NA&gt;     Paul     6      0      2</code></pre>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" data-line-number="1"><span class="co"># The &#39;term&#39; headers appear four times, but only the first one is needed.</span></a>
<a class="sourceLine" id="cb226-2" data-line-number="2">term &lt;-</a>
<a class="sourceLine" id="cb226-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb226-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">term =</span> character)</a>
<a class="sourceLine" id="cb226-5" data-line-number="5">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb226-6" data-line-number="6">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb226-7" data-line-number="7">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb226-8" data-line-number="8">term</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##     row   col term  
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Term 1
## 2     2     5 Term 2
## 3     2     6 Term 3</code></pre>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" data-line-number="1">subject &lt;-</a>
<a class="sourceLine" id="cb228-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb228-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb228-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb228-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb228-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb228-7" data-line-number="7">subject</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     2 Classics
## 2     8     2 History 
## 3    13     2 Music   
## 4    18     2 Drama</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" data-line-number="1">name &lt;-</a>
<a class="sourceLine" id="cb230-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb230-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb230-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb230-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb230-6" data-line-number="6">name</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col name    
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
##  1     3     3 Matilda 
##  2     4     3 Nicholas
##  3     5     3 Olivia  
##  4     6     3 Paul    
##  5     8     3 Matilda 
##  6     9     3 Nicholas
##  7    10     3 Olivia  
##  8    11     3 Paul    
##  9    13     3 Matilda 
## 10    14     3 Nicholas
## 11    15     3 Olivia  
## 12    16     3 Paul    
## 13    18     3 Matilda 
## 14    19     3 Nicholas
## 15    20     3 Olivia  
## 16    21     3 Paul</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" data-line-number="1"><span class="co"># The data cells are distinguished from the &#39;term&#39; headers by their data type --</span></a>
<a class="sourceLine" id="cb232-2" data-line-number="2"><span class="co"># the data cells are numeric, whereas the term headers are character.</span></a>
<a class="sourceLine" id="cb232-3" data-line-number="3">data_cells &lt;-</a>
<a class="sourceLine" id="cb232-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb232-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb232-6" data-line-number="6">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb232-7" data-line-number="7">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb232-8" data-line-number="8">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb232-9" data-line-number="9">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb232-10" data-line-number="10">data_cells</a></code></pre></div>
<pre><code>## # A tibble: 48 x 3
##      row   col score
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
##  1     3     4     1
##  2     3     5     8
##  3     3     6     7
##  4     4     4     3
##  5     4     5     1
##  6     4     6     2
##  7     5     4     4
##  8     5     5     0
##  9     5     6     1
## 10     6     4     2
## # ... with 38 more rows</code></pre>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb234-1" data-line-number="1">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-2" data-line-number="2"><span class="st">  </span><span class="kw">enhead</span>(term, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-3" data-line-number="3"><span class="st">  </span><span class="kw">enhead</span>(subject, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-4" data-line-number="4"><span class="st">  </span><span class="kw">enhead</span>(name, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb234-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    score term   subject  name    
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;   
##  1     1 Term 1 Classics Matilda 
##  2     8 Term 2 Classics Matilda 
##  3     7 Term 3 Classics Matilda 
##  4     3 Term 1 Classics Nicholas
##  5     1 Term 2 Classics Nicholas
##  6     2 Term 3 Classics Nicholas
##  7     4 Term 1 Classics Olivia  
##  8     0 Term 2 Classics Olivia  
##  9     1 Term 3 Classics Olivia  
## 10     2 Term 1 Classics Paul    
## # ... with 38 more rows</code></pre>
</div>
<div id="headers-amongst-the-data" class="section level3">
<h3><span class="header-section-number">3.2.9</span> Headers amongst the data</h3>
<p><img src="images/pivot-header-within-data.png" /></p>
<p>This happens when what is actually a row-header, instead of being presented to
the left of the data, is presented above the data. (Alternatively, what is
actually a column header, instead of being presented above the data, is
presented to the side.)</p>
<p>The way to handle it is to <em>pretend</em> that it is a row header, and use the
<code>&quot;WNW&quot;</code> direction as normal.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb236-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb236-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-header-within-data&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, local_format_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 80 x 6
##      row   col data_type character numeric local_format_id
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;           &lt;int&gt;
##  1     2     3 character Classics       NA               2
##  2     3     3 character Term 1         NA              20
##  3     3     4 character Term 2         NA              37
##  4     3     5 character Term 3         NA              21
##  5     4     2 character Matilda        NA              18
##  6     4     3 numeric   &lt;NA&gt;            4              18
##  7     4     4 numeric   &lt;NA&gt;            0              27
##  8     4     5 numeric   &lt;NA&gt;            7              19
##  9     5     2 character Nicholas       NA              20
## 10     5     3 numeric   &lt;NA&gt;            4              20
## # ... with 70 more rows</code></pre>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb238-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb238-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 24 x 5
##    `row/col` `2(B)`   `3(C)`   `4(D)` `5(E)`
##        &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
##  1         2 &lt;NA&gt;     Classics &lt;NA&gt;   &lt;NA&gt;  
##  2         3 &lt;NA&gt;     Term 1   Term 2 Term 3
##  3         4 Matilda  4        0      7     
##  4         5 Nicholas 4        6      2     
##  5         6 Olivia   9        9      9     
##  6         7 Paul     5        0      0     
##  7         8 &lt;NA&gt;     History  &lt;NA&gt;   &lt;NA&gt;  
##  8         9 &lt;NA&gt;     Term 1   Term 2 Term 3
##  9        10 Matilda  0        4      2     
## 10        11 Nicholas 2        5      2     
## # ... with 14 more rows</code></pre>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb240-1" data-line-number="1">bold &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>bold)</a>
<a class="sourceLine" id="cb240-2" data-line-number="2"></a>
<a class="sourceLine" id="cb240-3" data-line-number="3"><span class="co"># The subject headers, though mixed with the data and the &#39;term&#39; headers, are</span></a>
<a class="sourceLine" id="cb240-4" data-line-number="4"><span class="co"># distinguishable by the data type &quot;character&quot; and by being bold.</span></a>
<a class="sourceLine" id="cb240-5" data-line-number="5">subject &lt;-</a>
<a class="sourceLine" id="cb240-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells,</a>
<a class="sourceLine" id="cb240-7" data-line-number="7">         col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb240-8" data-line-number="8">         data_type <span class="op">==</span><span class="st"> &quot;character&quot;</span>,</a>
<a class="sourceLine" id="cb240-9" data-line-number="9">         local_format_id <span class="op">%in%</span><span class="st"> </span>bold) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb240-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb240-11" data-line-number="11">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb240-12" data-line-number="12">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb240-13" data-line-number="13">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb240-14" data-line-number="14">subject</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     2     3 Classics
## 2     8     3 History 
## 3    14     3 Music   
## 4    20     3 Drama</code></pre>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb242-1" data-line-number="1"><span class="co"># We only need one set of the &#39;term&#39; headers</span></a>
<a class="sourceLine" id="cb242-2" data-line-number="2">term &lt;-</a>
<a class="sourceLine" id="cb242-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>, data_type <span class="op">==</span><span class="st"> &quot;character&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb242-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">term =</span> character)</a>
<a class="sourceLine" id="cb242-5" data-line-number="5">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb242-6" data-line-number="6">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb242-7" data-line-number="7">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb242-8" data-line-number="8">term</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##     row   col term  
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     3     3 Term 1
## 2     3     4 Term 2
## 3     3     5 Term 3</code></pre>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb244-1" data-line-number="1">name &lt;-</a>
<a class="sourceLine" id="cb244-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb244-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb244-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb244-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb244-6" data-line-number="6">name</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col name    
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
##  1     4     2 Matilda 
##  2     5     2 Nicholas
##  3     6     2 Olivia  
##  4     7     2 Paul    
##  5    10     2 Matilda 
##  6    11     2 Nicholas
##  7    12     2 Olivia  
##  8    13     2 Paul    
##  9    16     2 Matilda 
## 10    17     2 Nicholas
## 11    18     2 Olivia  
## 12    19     2 Paul    
## 13    22     2 Matilda 
## 14    23     2 Nicholas
## 15    24     2 Olivia  
## 16    25     2 Paul</code></pre>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb246-1" data-line-number="1"><span class="co"># The data cells are distinguished from the &#39;subject&#39; headers by their data</span></a>
<a class="sourceLine" id="cb246-2" data-line-number="2"><span class="co"># type -- the data cells are numeric, whereas the term headers are character.</span></a>
<a class="sourceLine" id="cb246-3" data-line-number="3">data_cells &lt;-</a>
<a class="sourceLine" id="cb246-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb246-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb246-6" data-line-number="6">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb246-7" data-line-number="7">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb246-8" data-line-number="8">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb246-9" data-line-number="9">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb246-10" data-line-number="10">data_cells</a></code></pre></div>
<pre><code>## # A tibble: 48 x 3
##      row   col score
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
##  1     4     3     4
##  2     4     4     0
##  3     4     5     7
##  4     5     3     4
##  5     5     4     6
##  6     5     5     2
##  7     6     3     9
##  8     6     4     9
##  9     6     5     9
## 10     7     3     5
## # ... with 38 more rows</code></pre>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb248-1" data-line-number="1">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-2" data-line-number="2"><span class="st">  </span><span class="kw">enhead</span>(subject, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-3" data-line-number="3"><span class="st">  </span><span class="kw">enhead</span>(term, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-4" data-line-number="4"><span class="st">  </span><span class="kw">enhead</span>(name, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb248-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    score subject  term   name    
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;   
##  1     4 Classics Term 1 Matilda 
##  2     0 Classics Term 2 Matilda 
##  3     7 Classics Term 3 Matilda 
##  4     4 Classics Term 1 Nicholas
##  5     6 Classics Term 2 Nicholas
##  6     2 Classics Term 3 Nicholas
##  7     9 Classics Term 1 Olivia  
##  8     9 Classics Term 2 Olivia  
##  9     9 Classics Term 3 Olivia  
## 10     5 Classics Term 1 Paul    
## # ... with 38 more rows</code></pre>

</div>
</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="pivot-simple.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="small-multiples.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/nacnudus/spreadsheet-munging-strategies/edit/master/pivot-tables.Rmd",
"text": "Edit"
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "none"
}
});
});
</script>

</body>

</html>
