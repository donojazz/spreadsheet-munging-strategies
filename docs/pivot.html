<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Spreadsheet Munging Strategies</title>
  <meta name="description" content="Spreadsheet Munging Strategies">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Spreadsheet Munging Strategies" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Spreadsheet Munging Strategies" />
  
  
  

<meta name="author" content="Duncan Garmonsway">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="tidy-clean.html">
<link rel="next" href="small-multiples.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="setup.html"><a href="setup.html#packages"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="setup.html"><a href="setup.html#data"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidy.html"><a href="tidy.html"><i class="fa fa-check"></i><b>2</b> Tidy tables with gotchas</a></li>
<li class="chapter" data-level="3" data-path="tidy-clean.html"><a href="tidy-clean.html"><i class="fa fa-check"></i><b>3</b> Clean, tidy tables</a><ul>
<li class="chapter" data-level="3.1" data-path="tidy-clean.html"><a href="tidy-clean.html#tidy-tables-with-gotchas"><i class="fa fa-check"></i><b>3.1</b> Tidy tables with gotchas</a><ul>
<li class="chapter" data-level="3.1.1" data-path="tidy-clean.html"><a href="tidy-clean.html#transposed-headers-in-the-first-row-data-extends-to-the-right"><i class="fa fa-check"></i><b>3.1.1</b> Transposed (headers in the first row, data extends to the right)</a></li>
<li class="chapter" data-level="3.1.2" data-path="tidy-clean.html"><a href="tidy-clean.html#other-stuff-on-the-same-sheet"><i class="fa fa-check"></i><b>3.1.2</b> Other stuff on the same sheet</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="tidy-clean.html"><a href="tidy-clean.html#tidy-formatted-rows"><i class="fa fa-check"></i><b>3.2</b> Meaningfully formatted rows</a></li>
<li class="chapter" data-level="3.3" data-path="tidy-clean.html"><a href="tidy-clean.html#tidy-formatted-cells"><i class="fa fa-check"></i><b>3.3</b> Meaningfully formatted cells</a></li>
<li class="chapter" data-level="3.4" data-path="tidy-clean.html"><a href="tidy-clean.html#layered-formatting"><i class="fa fa-check"></i><b>3.4</b> Layered meaningful formatting</a></li>
<li class="chapter" data-level="3.5" data-path="tidy-clean.html"><a href="tidy-clean.html#hierarchies-in-formatting"><i class="fa fa-check"></i><b>3.5</b> Hierarchies in formatting</a></li>
<li class="chapter" data-level="3.6" data-path="tidy-clean.html"><a href="tidy-clean.html#tidy-sentinel"><i class="fa fa-check"></i><b>3.6</b> Sentinel values in non-text columns</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pivot.html"><a href="pivot.html"><i class="fa fa-check"></i><b>4</b> Pivot tables</a><ul>
<li class="chapter" data-level="4.1" data-path="pivot.html"><a href="pivot.html#pivot-simple"><i class="fa fa-check"></i><b>4.1</b> Simple unpivoting</a><ul>
<li class="chapter" data-level="4.1.1" data-path="pivot.html"><a href="pivot.html#two-clear-rows-of-text-column-headers-left-aligned"><i class="fa fa-check"></i><b>4.1.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="4.1.2" data-path="pivot.html"><a href="pivot.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned"><i class="fa fa-check"></i><b>4.1.2</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="4.1.3" data-path="pivot.html"><a href="pivot.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting"><i class="fa fa-check"></i><b>4.1.3</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="pivot.html"><a href="pivot.html#pivot-complex"><i class="fa fa-check"></i><b>4.2</b> Complex unpivoting</a><ul>
<li class="chapter" data-level="4.2.1" data-path="pivot.html"><a href="pivot.html#two-clear-rows-of-text-column-headers-left-aligned-2rl"><i class="fa fa-check"></i><b>4.2.1</b> Two clear rows of text column headers, left-aligned {#2RL}</a></li>
<li class="chapter" data-level="4.2.2" data-path="pivot.html"><a href="pivot.html#two-clear-columns-of-text-row-headers-top-aligned"><i class="fa fa-check"></i><b>4.2.2</b> Two clear columns of text row headers, top-aligned</a></li>
<li class="chapter" data-level="4.2.3" data-path="pivot.html"><a href="pivot.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1"><i class="fa fa-check"></i><b>4.2.3</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="4.2.4" data-path="pivot.html"><a href="pivot.html#centre-aligned-headers"><i class="fa fa-check"></i><b>4.2.4</b> Centre-aligned headers</a></li>
<li class="chapter" data-level="4.2.5" data-path="pivot.html"><a href="pivot.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting-1"><i class="fa fa-check"></i><b>4.2.5</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
<li class="chapter" data-level="4.2.6" data-path="pivot.html"><a href="pivot.html#mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>4.2.6</b> Mixed headers and notes in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="4.2.7" data-path="pivot.html"><a href="pivot.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>4.2.7</b> Mixed levels of headers in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="4.2.8" data-path="pivot.html"><a href="pivot.html#repeated-rowscolumns-of-headers-within-the-table"><i class="fa fa-check"></i><b>4.2.8</b> Repeated rows/columns of headers within the table</a></li>
<li class="chapter" data-level="4.2.9" data-path="pivot.html"><a href="pivot.html#headers-amongst-the-data"><i class="fa fa-check"></i><b>4.2.9</b> Headers amongst the data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="small-multiples.html"><a href="small-multiples.html"><i class="fa fa-check"></i><b>5</b> Small multiples</a><ul>
<li class="chapter" data-level="5.1" data-path="small-multiples.html"><a href="small-multiples.html#small-multiples-with-all-headers-present-for-each-multiple"><i class="fa fa-check"></i><b>5.1</b> Small multiples with all headers present for each multiple</a></li>
<li class="chapter" data-level="5.2" data-path="small-multiples.html"><a href="small-multiples.html#same-table-in-several-worksheetsfiles-using-the-sheetfile-name"><i class="fa fa-check"></i><b>5.2</b> Same table in several worksheets/files (using the sheet/file name)</a></li>
<li class="chapter" data-level="5.3" data-path="small-multiples.html"><a href="small-multiples.html#same-table-in-several-worksheetsfiles-but-in-different-positions"><i class="fa fa-check"></i><b>5.3</b> Same table in several worksheets/files but in different positions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="formatting.html"><a href="formatting.html"><i class="fa fa-check"></i><b>6</b> Formatting</a><ul>
<li class="chapter" data-level="6.1" data-path="formatting.html"><a href="formatting.html#an-example-formatting-lookup"><i class="fa fa-check"></i><b>6.1</b> An example formatting lookup</a></li>
<li class="chapter" data-level="6.2" data-path="formatting.html"><a href="formatting.html#common-formats"><i class="fa fa-check"></i><b>6.2</b> Common formats</a></li>
<li class="chapter" data-level="6.3" data-path="formatting.html"><a href="formatting.html#in-cell-formatting"><i class="fa fa-check"></i><b>6.3</b> In-cell formatting</a></li>
<li class="chapter" data-level="6.4" data-path="formatting.html"><a href="formatting.html#multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting"><i class="fa fa-check"></i><b>6.4</b> Multiple pieces of information in a single cell, with meaningful formatting</a></li>
<li class="chapter" data-level="6.5" data-path="formatting.html"><a href="formatting.html#superscript-symbols"><i class="fa fa-check"></i><b>6.5</b> Superscript symbols</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="data-validation.html"><a href="data-validation.html"><i class="fa fa-check"></i><b>7</b> Data validation</a></li>
<li class="chapter" data-level="8" data-path="formulas.html"><a href="formulas.html"><i class="fa fa-check"></i><b>8</b> Formulas</a></li>
<li class="chapter" data-level="9" data-path="other-gotchas.html"><a href="other-gotchas.html"><i class="fa fa-check"></i><b>9</b> Other gotchas</a><ul>
<li class="chapter" data-level="9.1" data-path="other-gotchas.html"><a href="other-gotchas.html#non-text-headers-e.g.dates"><i class="fa fa-check"></i><b>9.1</b> Non-text headers e.g. dates</a></li>
<li class="chapter" data-level="9.2" data-path="other-gotchas.html"><a href="other-gotchas.html#data-embedded-in-comments"><i class="fa fa-check"></i><b>9.2</b> Data embedded in comments</a></li>
<li class="chapter" data-level="9.3" data-path="other-gotchas.html"><a href="other-gotchas.html#named-ranges"><i class="fa fa-check"></i><b>9.3</b> Named ranges</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spreadsheet Munging Strategies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="pivot" class="section level1">
<h1><span class="header-section-number">4</span> Pivot tables</h1>
<p><img src="images/pivot-annotations.png" /></p>
<p>This part introduces pivot tables. <a href="https://nacnudus.github.io/tidyxl">Tidyxl</a>
and <a href="https://nacnudus.github.io/unpivotr">unpivotr</a> come into their own here,
and are (as far as I know) the only the only packages to acknowledge the
intuitive grammar of pivot tables.</p>
<p>Pivot tables are ones with more than one row of column headers, or more than one
column of row headers, or both (and there can be more complex arrangements).
Tables in that form take up less space on a page or a screen than ‘tidy’ tables,
and are easier for humans to read. But most software can’t interpret or traverse
data in that form; it must first be reshaped into a long, ‘tidy’ form, with a
single row of column headers.</p>
<p>It takes a lot of code to reshape a pivot table into a ‘tidy’ one, and the code
has to be bespoke for each table. There’s no general solution, because it is
ambiguous whether a given cell is part of a header or part of the data.</p>
<p>There are some ambiguities in ‘tidy’ tables, too, which is why most functions
for reading csv files allow you to specify whether the first row of the data is
a header, and how many rows to skip before the data begins. Functions often
guess, but they can never be certain.</p>
<p>Pivot tables, being more complex, are so much more ambiguous that it isn’t
reasonable to import them with a single function. A better way is to break the
problem down into steps:</p>
<ol style="list-style-type: decimal">
<li>Identify which cells are headers, and which are data.</li>
<li>State how the data cells relate to the header cells.</li>
</ol>
<p>The first step is a matter of traversing the cells, which is <em>much easier</em> if
you load them with the <a href="https://nacnudus.github.io/tidyxl">tidyxl</a> package, or
pass the table through <code>as_cells()</code> in the
<a href="https://nacnudus.github.io/unpivotr">unpivotr</a> package. This gives you a table
of cells and their properties; one row of the table describes one cell of the
source table or spreadsheet. The first two properties are the row and column
position of the cell, which makes it easy to filter for cells in a particular
region of the spreadsheet. If the first row of cells is a header row, then you
can filter for <code>row == 1</code>.</p>
<p>Here is an example of a pivot table where the first two rows, and the first two
columns, are headers. The other cells contain the data. First, see how the
cells are laid out in the source file by importing it with readxl.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb88-2" data-line-number="2">original &lt;-<span class="st"> </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;pivot-annotations&quot;</span>, <span class="dt">col_names =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb88-3" data-line-number="3"><span class="kw">print</span>(original, <span class="dt">n =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##   X__1        X__2     X__3    X__4   X__5     X__6 
##   &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;
## 1 &lt;NA&gt;        &lt;NA&gt;     Female  &lt;NA&gt;   Male     &lt;NA&gt; 
## 2 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul 
## 3 Humanities  Classics 1       2      3        0    
## 4 &lt;NA&gt;        History  3       4      5        1    
## 5 Performance Music    5       6      9        2    
## 6 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<p>Compare that with the long set of cells, one per row, that tidyxl gives. (Only
a few properties of each cell are shown, to make it easier to read).</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1">cells &lt;-<span class="st"> </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>)</a>
<a class="sourceLine" id="cb90-2" data-line-number="2"><span class="kw">select</span>(cells, row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-3" data-line-number="3"><span class="st">  </span><span class="kw">print</span>(cells, <span class="dt">n =</span> <span class="dv">20</span>)</a></code></pre></div>
<pre><code>## # A tibble: 36 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     2 blank     &lt;NA&gt;            NA
##  2     2     3 blank     &lt;NA&gt;            NA
##  3     2     4 character Female          NA
##  4     2     5 blank     &lt;NA&gt;            NA
##  5     2     6 character Male            NA
##  6     2     7 blank     &lt;NA&gt;            NA
##  7     3     2 blank     &lt;NA&gt;            NA
##  8     3     3 blank     &lt;NA&gt;            NA
##  9     3     4 character Matilda         NA
## 10     3     5 character Olivia          NA
## 11     3     6 character Nicholas        NA
## 12     3     7 character Paul            NA
## 13     4     2 character Humanities      NA
## 14     4     3 character Classics        NA
## 15     4     4 numeric   &lt;NA&gt;             1
## 16     4     5 numeric   &lt;NA&gt;             2
## 17     4     6 numeric   &lt;NA&gt;             3
## 18     4     7 numeric   &lt;NA&gt;             0
## 19     5     2 blank     &lt;NA&gt;            NA
## 20     5     3 character History         NA
## # ... with 16 more rows</code></pre>
<p>A similar result is obtained via <code>unpivotr::as_cells()</code>.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1">original &lt;-<span class="st"> </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;pivot-annotations&quot;</span>, <span class="dt">col_names =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb92-2" data-line-number="2"><span class="kw">as_cells</span>(original) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-3" data-line-number="3"><span class="st">  </span><span class="kw">arrange</span>(row, col) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-4" data-line-number="4"><span class="st">  </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="dv">20</span>)</a></code></pre></div>
<pre><code>## # A tibble: 36 x 4
##      row   col data_type chr       
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;     
##  1     1     1 chr       &lt;NA&gt;      
##  2     1     2 chr       &lt;NA&gt;      
##  3     1     3 chr       Female    
##  4     1     4 chr       &lt;NA&gt;      
##  5     1     5 chr       Male      
##  6     1     6 chr       &lt;NA&gt;      
##  7     2     1 chr       &lt;NA&gt;      
##  8     2     2 chr       &lt;NA&gt;      
##  9     2     3 chr       Matilda   
## 10     2     4 chr       Olivia    
## 11     2     5 chr       Nicholas  
## 12     2     6 chr       Paul      
## 13     3     1 chr       Humanities
## 14     3     2 chr       Classics  
## 15     3     3 chr       1         
## 16     3     4 chr       2         
## 17     3     5 chr       3         
## 18     3     6 chr       0         
## 19     4     1 chr       &lt;NA&gt;      
## 20     4     2 chr       History   
## # ... with 16 more rows</code></pre>
<p>(One difference is that <code>read_excel()</code> has filled in some missing cells with
blanks, which <code>as_cells()</code> retains. Another is that <code>read_excel()</code> has
coerced all data types to <code>character</code>, whereas <code>xlsx_cells()</code> preserved the
original data types.)</p>
<p>The tidyxl version is easier to traverse, because it describes the position of
each cell as well as the value. To filter for the first row of headers:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1">dplyr<span class="op">::</span><span class="kw">filter</span>(cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, <span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb94-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(row, col, character, numeric)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##     row   col character numeric
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1     2     4 Female         NA
## 2     2     6 Male           NA</code></pre>
<p>Or to filter for cells containing data (in this case, we know that only data
cells are numeric)</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1">dplyr<span class="op">::</span><span class="kw">filter</span>(cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(row, col, numeric)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col numeric
##    &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;
##  1     4     4       1
##  2     4     5       2
##  3     4     6       3
##  4     4     7       0
##  5     5     4       3
##  6     5     5       4
##  7     5     6       5
##  8     5     7       1
##  9     6     4       5
## 10     6     5       6
## 11     6     6       9
## 12     6     7       2
## 13     7     4       7
## 14     7     5       8
## 15     7     6      12
## 16     7     7       3</code></pre>
<p>By identifying the header cells separately from the data cells, and knowing
exactly where they are on the sheet, we can associated the data cells with the
relevant headers.</p>
<p>To a human it is intuitive that the cells below and to the right of the header
<code>Male</code> represent males, and that ones to the right of and below the header
<code>Postgraduate qualification</code> represent people with postgraduate qualifications,
but it isn’t so obvious to the computer. How would the computer know that the
header <code>Male</code> doesn’t also relate to the column of cells below and to the left,
beginning with <code>2</code>?</p>
<p>This section shows how you can express the relationships between headers and
data cells, using the <a href="https://nacnudus.github.io/unpivotr">unpivotr</a> package.</p>

<div id="pivot-simple" class="section level2">
<h2><span class="header-section-number">4.1</span> Simple unpivoting</h2>
<p>The <code>behead()</code> function takes one level of headers from a pivot table and makes
it part of the data. Think of it like <code>tidyr::gather()</code>, except that it works
when there is more than one row of headers (or more than one column of
row-headers), and it only works on tables that have first come through
<code>as_cells()</code> or <code>tidyxl::xlsx_cells()</code>.</p>
<div id="two-clear-rows-of-text-column-headers-left-aligned" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Two clear rows of text column headers, left-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>Here we have a pivot table with two rows of column headers. The first row of
headers is left-aligned, so <code>&quot;Female&quot;</code> applies to the first two columns of data,
and <code>&quot;Male&quot;</code> applies to the next two. The second row of headers has a header in
every column.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb98-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb98-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, <span class="op">!</span>is_blank) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Ignore the row headers in this example</span></a>
<a class="sourceLine" id="cb98-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric)</a>
<a class="sourceLine" id="cb98-6" data-line-number="6">all_cells</a></code></pre></div>
<pre><code>## # A tibble: 22 x 5
##      row   col data_type character numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
##  1     2     4 character Female         NA
##  2     2     6 character Male           NA
##  3     3     4 character Matilda        NA
##  4     3     5 character Olivia         NA
##  5     3     6 character Nicholas       NA
##  6     3     7 character Paul           NA
##  7     4     4 numeric   &lt;NA&gt;            1
##  8     4     5 numeric   &lt;NA&gt;            2
##  9     4     6 numeric   &lt;NA&gt;            3
## 10     4     7 numeric   &lt;NA&gt;            0
## # ... with 12 more rows</code></pre>
<p>The <code>behead()</code> function takes the ‘melted’ output of <code>as_cells()</code>,
<code>tidyxl::xlsx_cells()</code>, or a previous <code>behead()</code>, and three more arguments to
specify how the header cells relate to the data cells.</p>
<p>The outermost header is the top row, <code>&quot;Female&quot; NA &quot;Male&quot; NA</code>. The <code>&quot;Female&quot;</code>
and <code>&quot;Male&quot;</code> headers are above and to-the-left-of the data cells. We express
this as a compass direction, north-north-west, or <code>&quot;NNW&quot;</code>. We also give the
headers a name, <code>sex</code>, and say which column of <code>all_cells</code> contains the value
of the header cells – it’s usually the <code>character</code> column.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1">all_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-2" data-line-number="2"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, sex)</a></code></pre></div>
<pre><code>## # A tibble: 20 x 6
##      row   col data_type character numeric sex   
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt; 
##  1     3     4 character Matilda        NA Female
##  2     3     5 character Olivia         NA Female
##  3     3     6 character Nicholas       NA Male  
##  4     3     7 character Paul           NA Male  
##  5     4     4 numeric   &lt;NA&gt;            1 Female
##  6     4     5 numeric   &lt;NA&gt;            2 Female
##  7     4     6 numeric   &lt;NA&gt;            3 Male  
##  8     4     7 numeric   &lt;NA&gt;            0 Male  
##  9     5     4 numeric   &lt;NA&gt;            3 Female
## 10     5     5 numeric   &lt;NA&gt;            4 Female
## 11     5     6 numeric   &lt;NA&gt;            5 Male  
## 12     5     7 numeric   &lt;NA&gt;            1 Male  
## 13     6     4 numeric   &lt;NA&gt;            5 Female
## 14     6     5 numeric   &lt;NA&gt;            6 Female
## 15     6     6 numeric   &lt;NA&gt;            9 Male  
## 16     6     7 numeric   &lt;NA&gt;            2 Male  
## 17     7     4 numeric   &lt;NA&gt;            7 Female
## 18     7     5 numeric   &lt;NA&gt;            8 Female
## 19     7     6 numeric   &lt;NA&gt;           12 Male  
## 20     7     7 numeric   &lt;NA&gt;            3 Male</code></pre>
<p>That did half the job. The value 2 in row 4 column 5 is indeed a score of a
female. But the value <code>&quot;matilda&quot;</code> in row 3 column 4 isn’t a population – it’s
another header. The next step is to strip that second level of column headers.
This time, the compass direction is <code>&quot;N&quot;</code>, because the headers are directly
above the associated data cells, and we call it <code>name</code>, because it represents
names of people.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1">all_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-3" data-line-number="3"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, <span class="st">`</span><span class="dt">name</span><span class="st">`</span>)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 7
##      row   col data_type character numeric sex    name    
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   
##  1     4     4 numeric   &lt;NA&gt;            1 Female Matilda 
##  2     4     5 numeric   &lt;NA&gt;            2 Female Olivia  
##  3     4     6 numeric   &lt;NA&gt;            3 Male   Nicholas
##  4     4     7 numeric   &lt;NA&gt;            0 Male   Paul    
##  5     5     4 numeric   &lt;NA&gt;            3 Female Matilda 
##  6     5     5 numeric   &lt;NA&gt;            4 Female Olivia  
##  7     5     6 numeric   &lt;NA&gt;            5 Male   Nicholas
##  8     5     7 numeric   &lt;NA&gt;            1 Male   Paul    
##  9     6     4 numeric   &lt;NA&gt;            5 Female Matilda 
## 10     6     5 numeric   &lt;NA&gt;            6 Female Olivia  
## 11     6     6 numeric   &lt;NA&gt;            9 Male   Nicholas
## 12     6     7 numeric   &lt;NA&gt;            2 Male   Paul    
## 13     7     4 numeric   &lt;NA&gt;            7 Female Matilda 
## 14     7     5 numeric   &lt;NA&gt;            8 Female Olivia  
## 15     7     6 numeric   &lt;NA&gt;           12 Male   Nicholas
## 16     7     7 numeric   &lt;NA&gt;            3 Male   Paul</code></pre>
<p>A final step is a normal clean-up. We drop the <code>row</code>, <code>col</code> and <code>character</code>
columns, and we rename the <code>numeric</code> column to <code>score</code>, which is what it
represents.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1">all_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-2" data-line-number="2"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-3" data-line-number="3"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, <span class="st">`</span><span class="dt">name</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="dt">score =</span> numeric, sex, <span class="st">`</span><span class="dt">name</span><span class="st">`</span>)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score sex    name    
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   
##  1     1 Female Matilda 
##  2     2 Female Olivia  
##  3     3 Male   Nicholas
##  4     0 Male   Paul    
##  5     3 Female Matilda 
##  6     4 Female Olivia  
##  7     5 Male   Nicholas
##  8     1 Male   Paul    
##  9     5 Female Matilda 
## 10     6 Female Olivia  
## 11     9 Male   Nicholas
## 12     2 Male   Paul    
## 13     7 Female Matilda 
## 14     8 Female Olivia  
## 15    12 Male   Nicholas
## 16     3 Male   Paul</code></pre>
</div>
<div id="two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Two clear rows and columns of text headers, top-aligned and left-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>There are no new techniques are used, just more compass directions: <code>&quot;W&quot;</code> for
headers directly to the left of the data cells, and <code>&quot;WNW&quot;</code> for headers
left-and-above the data cells.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb106-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb106-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 28 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     4 character Female          NA
##  2     2     6 character Male            NA
##  3     3     4 character Matilda         NA
##  4     3     5 character Olivia          NA
##  5     3     6 character Nicholas        NA
##  6     3     7 character Paul            NA
##  7     4     2 character Humanities      NA
##  8     4     3 character Classics        NA
##  9     4     4 numeric   &lt;NA&gt;             1
## 10     4     5 numeric   &lt;NA&gt;             2
## # ... with 18 more rows</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" data-line-number="1">all_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb108-2" data-line-number="2"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, sex) <span class="op">%&gt;%</span><span class="st">   </span><span class="co"># As before</span></a>
<a class="sourceLine" id="cb108-3" data-line-number="3"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, <span class="st">`</span><span class="dt">name</span><span class="st">`</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># As before</span></a>
<a class="sourceLine" id="cb108-4" data-line-number="4"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;WNW&quot;</span>, field) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Left-and-above</span></a>
<a class="sourceLine" id="cb108-5" data-line-number="5"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, subject) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Directly left</span></a>
<a class="sourceLine" id="cb108-6" data-line-number="6"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">score =</span> numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb108-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col, <span class="op">-</span>character)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 6
##    data_type score sex    name     field       subject 
##    &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;   
##  1 numeric       1 Female Matilda  Humanities  Classics
##  2 numeric       2 Female Olivia   Humanities  Classics
##  3 numeric       3 Male   Nicholas Humanities  Classics
##  4 numeric       0 Male   Paul     Humanities  Classics
##  5 numeric       3 Female Matilda  Humanities  History 
##  6 numeric       4 Female Olivia   Humanities  History 
##  7 numeric       5 Male   Nicholas Humanities  History 
##  8 numeric       1 Male   Paul     Humanities  History 
##  9 numeric       5 Female Matilda  Performance Music   
## 10 numeric       6 Female Olivia   Performance Music   
## 11 numeric       9 Male   Nicholas Performance Music   
## 12 numeric       2 Male   Paul     Performance Music   
## 13 numeric       7 Female Matilda  Performance Drama   
## 14 numeric       8 Female Olivia   Performance Drama   
## 15 numeric      12 Male   Nicholas Performance Drama   
## 16 numeric       3 Male   Paul     Performance Drama</code></pre>
</div>
<div id="multiple-rows-or-columns-of-headers-with-meaningful-formatting" class="section level3">
<h3><span class="header-section-number">4.1.3</span> Multiple rows or columns of headers, with meaningful formatting</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is a combination of the previous section with <a href="tidy-formatted-rows">meaningfully formatted
rows</a>. The section <a href="tidy-formatted-cells">meaninfully formatted
cells</a> doesn’t work here, because the unpivoting of
multiple rows/columns of headers complicates the relationship between the data
and the formatting.</p>
<ol style="list-style-type: decimal">
<li>Unpivot the multiple rows/columns of headers, as above, but keep the <code>row</code>
and <code>col</code> of each data cell.</li>
<li>Collect the <code>row</code>, <code>col</code> and formatting of each data cell.</li>
<li>Join the data to the formatting by the <code>row</code> and <code>col</code>.</li>
</ol>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb110-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb110-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb110-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb110-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb110-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 28 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     4 character Female          NA
##  2     2     6 character Male            NA
##  3     3     4 character Matilda         NA
##  4     3     5 character Olivia          NA
##  5     3     6 character Nicholas        NA
##  6     3     7 character Paul            NA
##  7     4     2 character Humanities      NA
##  8     4     3 character Classics        NA
##  9     4     4 numeric   &lt;NA&gt;             1
## 10     4     5 numeric   &lt;NA&gt;             2
## # ... with 18 more rows</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" data-line-number="1">unpivoted &lt;-</a>
<a class="sourceLine" id="cb112-2" data-line-number="2"><span class="st">  </span>all_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb112-3" data-line-number="3"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, sex) <span class="op">%&gt;%</span><span class="st">   </span><span class="co"># As before</span></a>
<a class="sourceLine" id="cb112-4" data-line-number="4"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, <span class="st">`</span><span class="dt">name</span><span class="st">`</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># As before</span></a>
<a class="sourceLine" id="cb112-5" data-line-number="5"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;WNW&quot;</span>, field) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Left-and-above</span></a>
<a class="sourceLine" id="cb112-6" data-line-number="6"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, subject) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Directly left</span></a>
<a class="sourceLine" id="cb112-7" data-line-number="7"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">score =</span> numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb112-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>character)                <span class="co"># Retain the row and col for now</span></a>
<a class="sourceLine" id="cb112-9" data-line-number="9">unpivoted</a></code></pre></div>
<pre><code>## # A tibble: 16 x 8
##      row   col data_type score sex    name     field       subject 
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;   
##  1     4     4 numeric       1 Female Matilda  Humanities  Classics
##  2     4     5 numeric       2 Female Olivia   Humanities  Classics
##  3     4     6 numeric       3 Male   Nicholas Humanities  Classics
##  4     4     7 numeric       0 Male   Paul     Humanities  Classics
##  5     5     4 numeric       3 Female Matilda  Humanities  History 
##  6     5     5 numeric       4 Female Olivia   Humanities  History 
##  7     5     6 numeric       5 Male   Nicholas Humanities  History 
##  8     5     7 numeric       1 Male   Paul     Humanities  History 
##  9     6     4 numeric       5 Female Matilda  Performance Music   
## 10     6     5 numeric       6 Female Olivia   Performance Music   
## 11     6     6 numeric       9 Male   Nicholas Performance Music   
## 12     6     7 numeric       2 Male   Paul     Performance Music   
## 13     7     4 numeric       7 Female Matilda  Performance Drama   
## 14     7     5 numeric       8 Female Olivia   Performance Drama   
## 15     7     6 numeric      12 Male   Nicholas Performance Drama   
## 16     7     7 numeric       3 Male   Paul     Performance Drama</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" data-line-number="1"><span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span></a>
<a class="sourceLine" id="cb114-2" data-line-number="2"><span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span></a>
<a class="sourceLine" id="cb114-3" data-line-number="3">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb114-4" data-line-number="4">fill_colours</a></code></pre></div>
<pre><code>##  [1] NA         NA         NA         NA         &quot;FFFFFF00&quot; NA        
##  [7] &quot;FFFFFF00&quot; NA         NA         NA         &quot;FFFFFF00&quot; &quot;FF92D050&quot;
## [13] NA         NA         NA         &quot;FFFFFF00&quot; NA         NA        
## [19] NA         NA         NA         NA         NA         NA        
## [25] NA         NA         NA         NA         NA         NA        
## [31] NA         &quot;FFFFFF00&quot; &quot;FFFFFF00&quot; NA         NA         NA        
## [37] NA         NA         NA         NA         NA         NA        
## [43] NA         NA         NA         NA         NA         NA        
## [49] NA         NA         NA         NA         NA         NA        
## [55] NA         &quot;FFFFC7CE&quot; NA         NA         NA         NA        
## [61] NA         NA         NA         NA         NA         NA</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" data-line-number="1"><span class="co"># Import all the cells, filter out the header row, filter for the first column,</span></a>
<a class="sourceLine" id="cb116-2" data-line-number="2"><span class="co"># and create a new column `approximate` based on the fill colours, by looking up</span></a>
<a class="sourceLine" id="cb116-3" data-line-number="3"><span class="co"># the local_format_id of each cell in the `formats` pallette.</span></a>
<a class="sourceLine" id="cb116-4" data-line-number="4">annotations &lt;-</a>
<a class="sourceLine" id="cb116-5" data-line-number="5"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the headers</span></a>
<a class="sourceLine" id="cb116-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(row, col, fill_colour)</a>
<a class="sourceLine" id="cb116-9" data-line-number="9">annotations</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col fill_colour
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
##  1     4     4 &lt;NA&gt;       
##  2     4     5 FFFFFF00   
##  3     4     6 &lt;NA&gt;       
##  4     4     7 &lt;NA&gt;       
##  5     5     4 FFFFFF00   
##  6     5     5 &lt;NA&gt;       
##  7     5     6 &lt;NA&gt;       
##  8     5     7 &lt;NA&gt;       
##  9     6     4 &lt;NA&gt;       
## 10     6     5 &lt;NA&gt;       
## 11     6     6 &lt;NA&gt;       
## 12     6     7 &lt;NA&gt;       
## 13     7     4 &lt;NA&gt;       
## 14     7     5 &lt;NA&gt;       
## 15     7     6 FFFFFF00   
## 16     7     7 &lt;NA&gt;</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" data-line-number="1"><span class="kw">left_join</span>(unpivoted, annotations, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 7
##    data_type score sex    name     field       subject  fill_colour
##    &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;      
##  1 numeric       1 Female Matilda  Humanities  Classics &lt;NA&gt;       
##  2 numeric       2 Female Olivia   Humanities  Classics FFFFFF00   
##  3 numeric       3 Male   Nicholas Humanities  Classics &lt;NA&gt;       
##  4 numeric       0 Male   Paul     Humanities  Classics &lt;NA&gt;       
##  5 numeric       3 Female Matilda  Humanities  History  FFFFFF00   
##  6 numeric       4 Female Olivia   Humanities  History  &lt;NA&gt;       
##  7 numeric       5 Male   Nicholas Humanities  History  &lt;NA&gt;       
##  8 numeric       1 Male   Paul     Humanities  History  &lt;NA&gt;       
##  9 numeric       5 Female Matilda  Performance Music    &lt;NA&gt;       
## 10 numeric       6 Female Olivia   Performance Music    &lt;NA&gt;       
## 11 numeric       9 Male   Nicholas Performance Music    &lt;NA&gt;       
## 12 numeric       2 Male   Paul     Performance Music    &lt;NA&gt;       
## 13 numeric       7 Female Matilda  Performance Drama    &lt;NA&gt;       
## 14 numeric       8 Female Olivia   Performance Drama    &lt;NA&gt;       
## 15 numeric      12 Male   Nicholas Performance Drama    FFFFFF00   
## 16 numeric       3 Male   Paul     Performance Drama    &lt;NA&gt;</code></pre>

</div>
</div>
<div id="pivot-complex" class="section level2">
<h2><span class="header-section-number">4.2</span> Complex unpivoting</h2>
<p>When <code>behead()</code> isn’t powerful enough (it makes certain assumptions, and it
doesn’t understand formatting), then you can get much more control by using
<code>enhead()</code>, which joins together two separate data frames of data cells and
header cells.</p>
<p>This kind of unpivoting is always done in two stages.</p>
<ol style="list-style-type: decimal">
<li>Identify which cells are headers, and which are data</li>
<li>State how the data cells relate to the header cells.</li>
</ol>
<div id="two-clear-rows-of-text-column-headers-left-aligned-2rl" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Two clear rows of text column headers, left-aligned {#2RL}</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>The first stage, identifying header vs data cells, is simply filtering.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb120-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb120-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, <span class="op">!</span>is_blank) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Ignore the row headers in this example</span></a>
<a class="sourceLine" id="cb120-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 22 x 5
##      row   col data_type character numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
##  1     2     4 character Female         NA
##  2     2     6 character Male           NA
##  3     3     4 character Matilda        NA
##  4     3     5 character Olivia         NA
##  5     3     6 character Nicholas       NA
##  6     3     7 character Paul           NA
##  7     4     4 numeric   &lt;NA&gt;            1
##  8     4     5 numeric   &lt;NA&gt;            2
##  9     4     6 numeric   &lt;NA&gt;            3
## 10     4     7 numeric   &lt;NA&gt;            0
## # ... with 12 more rows</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   `row/col` `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         2 Female  &lt;NA&gt;   Male     &lt;NA&gt;  
## 2         3 Matilda Olivia Nicholas Paul  
## 3         4 1       2      3        0     
## 4         5 3       4      5        1     
## 5         6 5       6      9        2     
## 6         7 7       8      12       3</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb124-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb124-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb124-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb124-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb124-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb126-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb126-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb126-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb126-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Matilda 
## 2     3     5 Olivia  
## 3     3     6 Nicholas
## 4     3     7 Paul</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb128-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb128-4" data-line-number="4">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb128-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb128-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb128-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a></code></pre></div>
<p>The second stage is to declare how the data cells relate to each row of column
headers. Unpivotr provides a set of functions for this, derived from the points
of the compass.</p>
<p>Starting from the point of view of a data cell, the relevant column header from
the second row of headers is the one directly north (up), or <code>&quot;N&quot;</code>.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1"><span class="kw">enhead</span>(data_cells, second_header_row, <span class="st">&quot;N&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 4
##      row   col score name    
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   
##  1     4     4     1 Matilda 
##  2     4     5     2 Olivia  
##  3     4     6     3 Nicholas
##  4     4     7     0 Paul    
##  5     5     4     3 Matilda 
##  6     5     5     4 Olivia  
##  7     5     6     5 Nicholas
##  8     5     7     1 Paul    
##  9     6     4     5 Matilda 
## 10     6     5     6 Olivia  
## 11     6     6     9 Nicholas
## 12     6     7     2 Paul    
## 13     7     4     7 Matilda 
## 14     7     5     8 Olivia  
## 15     7     6    12 Nicholas
## 16     7     7     3 Paul</code></pre>
<p>The first row of headers, from the point of view of a data cell, is either
directly north (up), or north and west (up and left), or <code>&quot;NNW&quot;</code>.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" data-line-number="1"><span class="kw">enhead</span>(data_cells, first_header_row, <span class="st">&quot;NNW&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 4
##      row   col score sex   
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; 
##  1     4     4     1 Female
##  2     4     5     2 Female
##  3     4     6     3 Male  
##  4     4     7     0 Male  
##  5     5     4     3 Female
##  6     5     5     4 Female
##  7     5     6     5 Male  
##  8     5     7     1 Male  
##  9     6     4     5 Female
## 10     6     5     6 Female
## 11     6     6     9 Male  
## 12     6     7     2 Male  
## 13     7     4     7 Female
## 14     7     5     8 Female
## 15     7     6    12 Male  
## 16     7     7     3 Male</code></pre>
<p>Piping everything together, we get a complete, tidy dataset, and can finally
drop the <code>row</code> and <code>col</code> columns.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" data-line-number="1">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-2" data-line-number="2"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-3" data-line-number="3"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score sex    name    
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   
##  1     1 Female Matilda 
##  2     2 Female Olivia  
##  3     3 Male   Nicholas
##  4     0 Male   Paul    
##  5     3 Female Matilda 
##  6     4 Female Olivia  
##  7     5 Male   Nicholas
##  8     1 Male   Paul    
##  9     5 Female Matilda 
## 10     6 Female Olivia  
## 11     9 Male   Nicholas
## 12     2 Male   Paul    
## 13     7 Female Matilda 
## 14     8 Female Olivia  
## 15    12 Male   Nicholas
## 16     3 Male   Paul</code></pre>
</div>
<div id="two-clear-columns-of-text-row-headers-top-aligned" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Two clear columns of text row headers, top-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is almost the same as <a href="2RL">Two clear rows of text column headers,
left-aligned</a>, but with different compass directions: <code>&quot;W&quot;</code> for directly
west (left), and <code>&quot;WNW&quot;</code> for west and north (left and up).</p>
<p>(<code>&quot;NNW&quot;</code> and <code>&quot;WNW&quot;</code> look like synonyms. They happen to be synonyms in
<code>enhead()</code>, but they aren’t in <code>behead()</code>.</p>
<p>In this example, the table has no column headers, only row headers. This is
artificial here, but sometimes table are deliberately laid out in transpose
form: the first column contains the headers, and the data extends in columns
from left to right instead of from top to bottom.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb135-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb135-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">3</span>, <span class="op">!</span>is_blank) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Ignore the column headers in this example</span></a>
<a class="sourceLine" id="cb135-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 26 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     3     4 character Matilda         NA
##  2     3     5 character Olivia          NA
##  3     3     6 character Nicholas        NA
##  4     3     7 character Paul            NA
##  5     4     2 character Humanities      NA
##  6     4     3 character Classics        NA
##  7     4     4 numeric   &lt;NA&gt;             1
##  8     4     5 numeric   &lt;NA&gt;             2
##  9     4     6 numeric   &lt;NA&gt;             3
## 10     4     7 numeric   &lt;NA&gt;             0
## # ... with 16 more rows</code></pre>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 5 x 7
##   `row/col` `2(B)`      `3(C)`   `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         3 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul  
## 2         4 Humanities  Classics 1       2      3        0     
## 3         5 &lt;NA&gt;        History  3       4      5        1     
## 4         6 Performance Music    5       6      9        2     
## 5         7 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb139-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb139-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb139-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb139-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb139-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb141-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb141-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb141-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb141-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb141-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb141-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb141-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     3 Classics
## 2     5     3 History 
## 3     6     3 Music   
## 4     7     3 Drama</code></pre>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb143-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb143-4" data-line-number="4">  <span class="co"># The data is examp scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb143-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb143-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb143-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb143-8" data-line-number="8"></a>
<a class="sourceLine" id="cb143-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score field       subject 
##    &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;   
##  1     1 Humanities  Classics
##  2     2 Humanities  Classics
##  3     3 Humanities  Classics
##  4     0 Humanities  Classics
##  5     3 Humanities  History 
##  6     4 Humanities  History 
##  7     5 Humanities  History 
##  8     1 Humanities  History 
##  9     5 Performance Music   
## 10     6 Performance Music   
## 11     9 Performance Music   
## 12     2 Performance Music   
## 13     7 Performance Drama   
## 14     8 Performance Drama   
## 15    12 Performance Drama   
## 16     3 Performance Drama</code></pre>
</div>
<div id="two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Two clear rows and columns of text headers, top-aligned and left-aligned</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is a combination of the previous two sections. No new techniques are used.</p>
<ol style="list-style-type: decimal">
<li>Identify which cells are headers, and which are data</li>
<li>State how the data cells relate to the header cells.</li>
</ol>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb145-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb145-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb145-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 28 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     4 character Female          NA
##  2     2     6 character Male            NA
##  3     3     4 character Matilda         NA
##  4     3     5 character Olivia          NA
##  5     3     6 character Nicholas        NA
##  6     3     7 character Paul            NA
##  7     4     2 character Humanities      NA
##  8     4     3 character Classics        NA
##  9     4     4 numeric   &lt;NA&gt;             1
## 10     4     5 numeric   &lt;NA&gt;             2
## # ... with 18 more rows</code></pre>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb147-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   `row/col` `2(B)`      `3(C)`   `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         2 &lt;NA&gt;        &lt;NA&gt;     Female  &lt;NA&gt;   Male     &lt;NA&gt;  
## 2         3 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul  
## 3         4 Humanities  Classics 1       2      3        0     
## 4         5 &lt;NA&gt;        History  3       4      5        1     
## 5         6 Performance Music    5       6      9        2     
## 6         7 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb149-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb149-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb149-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb149-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb149-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb149-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb151-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb151-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb151-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb151-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Matilda 
## 2     3     5 Olivia  
## 3     3     6 Nicholas
## 4     3     7 Paul</code></pre>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb153-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb153-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb153-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb153-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb153-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb153-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb155-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb155-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb155-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb155-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb155-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb155-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     3 Classics
## 2     5     3 History 
## 3     6     3 Music   
## 4     7     3 Drama</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb157-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb157-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb157-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb157-4" data-line-number="4">  <span class="co"># The data is examp scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb157-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb157-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb157-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb157-8" data-line-number="8"></a>
<a class="sourceLine" id="cb157-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb157-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb157-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb157-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb157-13" data-line-number="13"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb157-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 5
##    score sex    name     field       subject 
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;   
##  1     1 Female Matilda  Humanities  Classics
##  2     2 Female Olivia   Humanities  Classics
##  3     3 Male   Nicholas Humanities  Classics
##  4     0 Male   Paul     Humanities  Classics
##  5     3 Female Matilda  Humanities  History 
##  6     4 Female Olivia   Humanities  History 
##  7     5 Male   Nicholas Humanities  History 
##  8     1 Male   Paul     Humanities  History 
##  9     5 Female Matilda  Performance Music   
## 10     6 Female Olivia   Performance Music   
## 11     9 Male   Nicholas Performance Music   
## 12     2 Male   Paul     Performance Music   
## 13     7 Female Matilda  Performance Drama   
## 14     8 Female Olivia   Performance Drama   
## 15    12 Male   Nicholas Performance Drama   
## 16     3 Male   Paul     Performance Drama</code></pre>
</div>
<div id="centre-aligned-headers" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Centre-aligned headers</h3>
<p><img src="images/pivot-centre-aligned.png" /></p>
<p>Headers aren’t always aligned to one side of the data cells that they describe.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb159-2" data-line-number="2">all_cells &lt;-<span class="st"> </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-centre-aligned&quot;</span>)</a>
<a class="sourceLine" id="cb159-3" data-line-number="3"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 10
##    `row/col` `2(B)`    `3(C)`   `4(D)` `5(E)` `6(F)` `7(G)` `8(H)` `9(I)` 
##        &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  
##  1         2 &lt;NA&gt;      &lt;NA&gt;     &lt;NA&gt;   Female &lt;NA&gt;   &lt;NA&gt;   &lt;NA&gt;   Male   
##  2         3 &lt;NA&gt;      &lt;NA&gt;     Leah   Matil… Olivia Lenny  Max    Nichol…
##  3         4 &lt;NA&gt;      Classics 3      1      2      4      3      3      
##  4         5 Humaniti… History  8      3      4      7      5      5      
##  5         6 &lt;NA&gt;      Literat… 1      1      9      3      12     7      
##  6         7 &lt;NA&gt;      Philoso… 5      10     10     8      2      5      
##  7         8 &lt;NA&gt;      Languag… 5      4      5      9      8      3      
##  8         9 &lt;NA&gt;      Music    4      10     10     2      4      5      
##  9        10 Performa… Dance    4      5      6      4      12     9      
## 10        11 &lt;NA&gt;      Drama    2      7      8      6      1      12     
## # ... with 1 more variable: `10(J)` &lt;chr&gt;</code></pre>
<p>Looking at that table, it’s not immediately obvious where the boundary between
<code>Female</code> and <code>Male</code> falls, or between <code>Humanities</code> and <code>Performance</code>. A naive
approach would be to match the inner headers to the outer ones by proximity, and
there are four directions to do so: <code>&quot;ABOVE&quot;</code>, <code>&quot;LEFT&quot;</code>, <code>&quot;BELOW&quot;</code>, and
<code>&quot;RIGHT&quot;</code>.</p>
<p>But in this case, those directions are too naive.</p>
<ul>
<li><code>Languages</code> is closest to the <code>Performance</code> header, but is a humanity.</li>
<li><code>Lenny</code> is the same distance from <code>Female</code> as from <code>Male</code>.</li>
</ul>
<p>You can fix this by justifying the header cells towards one side of the data
cells that they describe, and then use a direction like <code>&quot;NNW&quot;</code> as usual. Do
this with <code>justify()</code>, providing the header cells with a second set of cells
at the positions you want the header cells to move to.</p>
<ul>
<li><code>header_cells</code> is the cells whose value will be used as the header</li>
<li><code>corner_cells</code> is the cells whose position is in one corner of the domain of
the header (e.g. the top-left-hand corner).</li>
</ul>
<p>In the original spreadsheet, the borders mark the boundaries. So the corner
cells of the headers can be found by filtering for cells with a particular
border.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb161-1" data-line-number="1">all_cells &lt;-</a>
<a class="sourceLine" id="cb161-2" data-line-number="2"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-centre-aligned&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, is_blank, data_type, character, numeric, local_format_id)</a>
<a class="sourceLine" id="cb161-4" data-line-number="4"></a>
<a class="sourceLine" id="cb161-5" data-line-number="5">formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)</a>
<a class="sourceLine" id="cb161-6" data-line-number="6">top_borders &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(formats<span class="op">$</span>local<span class="op">$</span>border<span class="op">$</span>top<span class="op">$</span>style))</a>
<a class="sourceLine" id="cb161-7" data-line-number="7">left_borders &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(formats<span class="op">$</span>local<span class="op">$</span>border<span class="op">$</span>left<span class="op">$</span>style))</a>
<a class="sourceLine" id="cb161-8" data-line-number="8"></a>
<a class="sourceLine" id="cb161-9" data-line-number="9">first_header_row_corners &lt;-</a>
<a class="sourceLine" id="cb161-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>left_borders) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(row, col)</a>
<a class="sourceLine" id="cb161-12" data-line-number="12">first_header_row_corners</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##     row   col
##   &lt;int&gt; &lt;int&gt;
## 1     2     4
## 2     2     7</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb163-1" data-line-number="1">first_header_col_corners &lt;-</a>
<a class="sourceLine" id="cb163-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>top_borders) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb163-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col)</a>
<a class="sourceLine" id="cb163-4" data-line-number="4">first_header_col_corners</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##     row   col
##   &lt;int&gt; &lt;int&gt;
## 1     4     2
## 2     9     2</code></pre>
<p>Next, get the first row and first column of header cells as usual.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb165-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb165-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, <span class="op">!</span>is_blank, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb165-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb165-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb165-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb165-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb165-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     5 Female
## 2     2     9 Male</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb167-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb167-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, <span class="op">!</span>is_blank, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb167-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb167-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb167-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb167-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb167-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     5     2 Humanities 
## 2    10     2 Performance</code></pre>
<p>And now justify the header cells to the same positions as the corner cells.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb169-1" data-line-number="1">first_header_row &lt;-<span class="st"> </span><span class="kw">justify</span>(first_header_row, first_header_row_corners)</a>
<a class="sourceLine" id="cb169-2" data-line-number="2">first_header_col &lt;-<span class="st"> </span><span class="kw">justify</span>(first_header_col, first_header_col_corners)</a>
<a class="sourceLine" id="cb169-3" data-line-number="3"></a>
<a class="sourceLine" id="cb169-4" data-line-number="4">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     7 Male</code></pre>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb171-1" data-line-number="1">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     9     2 Performance</code></pre>
<p>The rest of this example is the same as “Two clear rows and columns of text
headers, top-aligned and left-aligned”.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb173-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb173-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb173-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb173-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb173-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb173-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 7 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Leah    
## 2     3     5 Matilda 
## 3     3     6 Olivia  
## 4     3     7 Lenny   
## 5     3     8 Max     
## 6     3     9 Nicholas
## 7     3    10 Paul</code></pre>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb175-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb175-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb175-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb175-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb175-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb175-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb175-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 8 x 3
##     row   col subject   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;     
## 1     4     3 Classics  
## 2     5     3 History   
## 3     6     3 Literature
## 4     7     3 Philosophy
## 5     8     3 Languages 
## 6     9     3 Music     
## 7    10     3 Dance     
## 8    11     3 Drama</code></pre>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb177-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb177-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb177-4" data-line-number="4">  <span class="co"># The data is examp scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb177-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb177-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb177-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb177-8" data-line-number="8"></a>
<a class="sourceLine" id="cb177-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-13" data-line-number="13"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb177-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 56 x 5
##    score sex    name     field      subject 
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;   
##  1     3 Female Leah     Humanities Classics
##  2     1 Female Matilda  Humanities Classics
##  3     2 Female Olivia   Humanities Classics
##  4     4 Male   Lenny    Humanities Classics
##  5     3 Male   Max      Humanities Classics
##  6     3 Male   Nicholas Humanities Classics
##  7     0 Male   Paul     Humanities Classics
##  8     8 Female Leah     Humanities History 
##  9     3 Female Matilda  Humanities History 
## 10     4 Female Olivia   Humanities History 
## # ... with 46 more rows</code></pre>
</div>
<div id="multiple-rows-or-columns-of-headers-with-meaningful-formatting-1" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Multiple rows or columns of headers, with meaningful formatting</h3>
<p><img src="images/pivot-annotations.png" /></p>
<p>This is a combination of the previous section with <a href="tidy-formatted-cells">Meaningfully formatted
cells</a>. The section <a href="tidy-formatted-rows">Meaningfully formatted
rows</a> doesn’t work here, because the unpivoting of multiple
rows/columns of headers complicates the relationship between the data and the
formatting.</p>
<ol style="list-style-type: decimal">
<li>Unpivot the multiple rows/columns of headers, as above, but keep the <code>row</code>
and <code>col</code> of each data cell.</li>
<li>Collect the <code>row</code>, <code>col</code> and formatting of each data cell.</li>
<li>Join the data to the formatting by the <code>row</code> and <code>col</code>.</li>
</ol>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb179-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb179-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb179-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb179-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb179-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb179-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 28 x 5
##      row   col data_type character  numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
##  1     2     4 character Female          NA
##  2     2     6 character Male            NA
##  3     3     4 character Matilda         NA
##  4     3     5 character Olivia          NA
##  5     3     6 character Nicholas        NA
##  6     3     7 character Paul            NA
##  7     4     2 character Humanities      NA
##  8     4     3 character Classics        NA
##  9     4     4 numeric   &lt;NA&gt;             1
## 10     4     5 numeric   &lt;NA&gt;             2
## # ... with 18 more rows</code></pre>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb181-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb181-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##   `row/col` `2(B)`      `3(C)`   `4(D)`  `5(E)` `6(F)`   `7(G)`
##       &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; 
## 1         2 &lt;NA&gt;        &lt;NA&gt;     Female  &lt;NA&gt;   Male     &lt;NA&gt;  
## 2         3 &lt;NA&gt;        &lt;NA&gt;     Matilda Olivia Nicholas Paul  
## 3         4 Humanities  Classics 1       2      3        0     
## 4         5 &lt;NA&gt;        History  3       4      5        1     
## 5         6 Performance Music    5       6      9        2     
## 6         7 &lt;NA&gt;        Drama    7       8      12       3</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb183-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb183-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb183-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb183-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb183-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb183-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb183-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb185-1" data-line-number="1">second_header_row &lt;-</a>
<a class="sourceLine" id="cb185-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb185-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb185-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb185-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb185-6" data-line-number="6">second_header_row</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     4 Matilda 
## 2     3     5 Olivia  
## 3     3     6 Nicholas
## 4     3     7 Paul</code></pre>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb187-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb187-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb187-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb187-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb187-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb187-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb187-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     4     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb189-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb189-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb189-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb189-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb189-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb189-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb189-7" data-line-number="7">second_header_col</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     3 Classics
## 2     5     3 History 
## 3     6     3 Music   
## 4     7     3 Drama</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb191-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb191-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb191-4" data-line-number="4">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb191-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb191-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb191-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb191-8" data-line-number="8"></a>
<a class="sourceLine" id="cb191-9" data-line-number="9">unpivoted &lt;-</a>
<a class="sourceLine" id="cb191-10" data-line-number="10"><span class="st">  </span>data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(second_header_row, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-13" data-line-number="13"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-14" data-line-number="14"><span class="st">  </span><span class="kw">enhead</span>(second_header_col, <span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb191-15" data-line-number="15">  <span class="co"># Don&#39;t delet the `row` and `col` columns yet, because we need them to join on</span></a>
<a class="sourceLine" id="cb191-16" data-line-number="16">  <span class="co"># the formatting</span></a>
<a class="sourceLine" id="cb191-17" data-line-number="17"></a>
<a class="sourceLine" id="cb191-18" data-line-number="18"><span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span></a>
<a class="sourceLine" id="cb191-19" data-line-number="19"><span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span></a>
<a class="sourceLine" id="cb191-20" data-line-number="20">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb191-21" data-line-number="21"></a>
<a class="sourceLine" id="cb191-22" data-line-number="22"><span class="co"># Import all the cells, filter out the header row, filter for the first column,</span></a>
<a class="sourceLine" id="cb191-23" data-line-number="23"><span class="co"># and create a new column `approximate` based on the fill colours, by looking up</span></a>
<a class="sourceLine" id="cb191-24" data-line-number="24"><span class="co"># the local_format_id of each cell in the `formats` pallette.</span></a>
<a class="sourceLine" id="cb191-25" data-line-number="25">annotations &lt;-</a>
<a class="sourceLine" id="cb191-26" data-line-number="26"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-27" data-line-number="27"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>, col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the headers</span></a>
<a class="sourceLine" id="cb191-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb191-29" data-line-number="29"><span class="st">  </span><span class="kw">select</span>(row, col, fill_colour)</a>
<a class="sourceLine" id="cb191-30" data-line-number="30">annotations</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col fill_colour
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
##  1     4     4 &lt;NA&gt;       
##  2     4     5 FFFFFF00   
##  3     4     6 &lt;NA&gt;       
##  4     4     7 &lt;NA&gt;       
##  5     5     4 FFFFFF00   
##  6     5     5 &lt;NA&gt;       
##  7     5     6 &lt;NA&gt;       
##  8     5     7 &lt;NA&gt;       
##  9     6     4 &lt;NA&gt;       
## 10     6     5 &lt;NA&gt;       
## 11     6     6 &lt;NA&gt;       
## 12     6     7 &lt;NA&gt;       
## 13     7     4 &lt;NA&gt;       
## 14     7     5 &lt;NA&gt;       
## 15     7     6 FFFFFF00   
## 16     7     7 &lt;NA&gt;</code></pre>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb193-1" data-line-number="1"><span class="kw">left_join</span>(unpivoted, annotations, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb193-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 6
##    score sex    name     field       subject  fill_colour
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;      
##  1     1 Female Matilda  Humanities  Classics &lt;NA&gt;       
##  2     2 Female Olivia   Humanities  Classics FFFFFF00   
##  3     3 Male   Nicholas Humanities  Classics &lt;NA&gt;       
##  4     0 Male   Paul     Humanities  Classics &lt;NA&gt;       
##  5     3 Female Matilda  Humanities  History  FFFFFF00   
##  6     4 Female Olivia   Humanities  History  &lt;NA&gt;       
##  7     5 Male   Nicholas Humanities  History  &lt;NA&gt;       
##  8     1 Male   Paul     Humanities  History  &lt;NA&gt;       
##  9     5 Female Matilda  Performance Music    &lt;NA&gt;       
## 10     6 Female Olivia   Performance Music    &lt;NA&gt;       
## 11     9 Male   Nicholas Performance Music    &lt;NA&gt;       
## 12     2 Male   Paul     Performance Music    &lt;NA&gt;       
## 13     7 Female Matilda  Performance Drama    &lt;NA&gt;       
## 14     8 Female Olivia   Performance Drama    &lt;NA&gt;       
## 15    12 Male   Nicholas Performance Drama    FFFFFF00   
## 16     3 Male   Paul     Performance Drama    &lt;NA&gt;</code></pre>
</div>
<div id="mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting" class="section level3">
<h3><span class="header-section-number">4.2.6</span> Mixed headers and notes in the same row/column, distinguished by formatting</h3>
<p><img src="images/pivot-notes.png" /></p>
<p>This doesn’t use any new techniques. The trick is, when selecting a row or
column of header cells, to filter out ones that have the ‘wrong’ formatting
(formatting that shows they aren’t really headers). In this example, cells with
italic or red text aren’t headers, even if they are in amongst header cells.</p>
<p>First, identify the IDs of formats that have italic or red text.</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb195-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb195-2" data-line-number="2">formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)</a>
<a class="sourceLine" id="cb195-3" data-line-number="3"></a>
<a class="sourceLine" id="cb195-4" data-line-number="4">italic &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>italic)</a>
<a class="sourceLine" id="cb195-5" data-line-number="5"></a>
<a class="sourceLine" id="cb195-6" data-line-number="6"><span class="co"># For &#39;red&#39; we can either look for the RGB code for red &quot;FFFF0000&quot;</span></a>
<a class="sourceLine" id="cb195-7" data-line-number="7">red &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb <span class="op">==</span><span class="st"> &quot;FFFF0000&quot;</span>)</a>
<a class="sourceLine" id="cb195-8" data-line-number="8">red</a></code></pre></div>
<pre><code>## [1]  4 10 11 18 34</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb197-1" data-line-number="1"><span class="co"># Or we can find out what that code is by starting from a cell that we know is</span></a>
<a class="sourceLine" id="cb197-2" data-line-number="2"><span class="co"># red.</span></a>
<a class="sourceLine" id="cb197-3" data-line-number="3">red_cell_format_id &lt;-</a>
<a class="sourceLine" id="cb197-4" data-line-number="4"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-notes&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb197-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">==</span><span class="st"> </span><span class="dv">5</span>, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb197-6" data-line-number="6"><span class="st">  </span><span class="kw">pull</span>(local_format_id)</a>
<a class="sourceLine" id="cb197-7" data-line-number="7">red_cell_format_id</a></code></pre></div>
<pre><code>## [1] 34</code></pre>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb199-1" data-line-number="1">red_rgb &lt;-<span class="st"> </span>formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb[red_cell_format_id]</a>
<a class="sourceLine" id="cb199-2" data-line-number="2">red &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>color<span class="op">$</span>rgb <span class="op">==</span><span class="st"> </span>red_rgb)</a>
<a class="sourceLine" id="cb199-3" data-line-number="3">red</a></code></pre></div>
<pre><code>## [1]  4 10 11 18 34</code></pre>
<p>Now we select the headers, filtering out cells with the format IDs of red or
italic cells.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb201-1" data-line-number="1">all_cells &lt;-</a>
<a class="sourceLine" id="cb201-2" data-line-number="2"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-notes&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb201-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb201-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, character, numeric, local_format_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb201-5" data-line-number="5"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 31 x 5
##      row   col character  numeric local_format_id
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;        &lt;dbl&gt;           &lt;int&gt;
##  1     2     4 Female          NA              26
##  2     2     6 Male            NA              26
##  3     2     7 0 = absent      NA              23
##  4     3     4 Matilda         NA              28
##  5     3     5 Olivia          NA              29
##  6     3     6 Nicholas        NA              28
##  7     3     7 Paul            NA              29
##  8     4     2 Humanities      NA              26
##  9     4     3 Classics        NA              27
## 10     4     4 &lt;NA&gt;             1              22
## # ... with 21 more rows</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb203-1" data-line-number="1">first_header_row &lt;-</a>
<a class="sourceLine" id="cb203-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, <span class="op">!</span>(local_format_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(red, italic))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb203-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">sex =</span> character)</a>
<a class="sourceLine" id="cb203-4" data-line-number="4">  <span class="co"># the title of this header is &#39;sex&#39;</span></a>
<a class="sourceLine" id="cb203-5" data-line-number="5">  <span class="co"># the cells are text cells (`&quot;Female&quot;` and `&quot;Male&quot;`) so take the value in the</span></a>
<a class="sourceLine" id="cb203-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb203-7" data-line-number="7">first_header_row</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col sex   
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Female
## 2     2     6 Male</code></pre>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb205-1" data-line-number="1">first_header_col &lt;-</a>
<a class="sourceLine" id="cb205-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, <span class="op">!</span>(local_format_id <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(red, italic))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb205-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">qualification =</span> character)</a>
<a class="sourceLine" id="cb205-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb205-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb205-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb205-7" data-line-number="7">first_header_col</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col qualification
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;        
## 1     4     2 Humanities   
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb207-1" data-line-number="1">second_header_col &lt;-</a>
<a class="sourceLine" id="cb207-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb207-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb207-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb207-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb207-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb207-7" data-line-number="7"></a>
<a class="sourceLine" id="cb207-8" data-line-number="8">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb207-9" data-line-number="9"><span class="st">  </span><span class="kw">enhead</span>(first_header_row, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb207-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(first_header_col, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb207-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##    score sex    qualification
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;        
##  1     1 Female Humanities   
##  2     2 Female Humanities   
##  3     3 Male   Humanities   
##  4     0 Male   Humanities   
##  5     3 Female Humanities   
##  6     4 Female Humanities   
##  7     5 Male   Humanities   
##  8     1 Male   Humanities   
##  9     5 Female Performance  
## 10     6 Female Performance  
## 11     9 Male   Performance  
## 12     2 Male   Performance  
## 13     7 Female Performance  
## 14     8 Female Performance  
## 15    12 Male   Performance  
## 16     3 Male   Performance</code></pre>
</div>
<div id="mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting" class="section level3">
<h3><span class="header-section-number">4.2.7</span> Mixed levels of headers in the same row/column, distinguished by formatting</h3>
<p><img src="images/pivot-hierarchy.png" /></p>
<p>Normally different levels of headers are in different rows, or different
columns, like <a href="2Rl">Two clear rows of text column headers, left-aligned</a>. But
sometimes they coexist in the same row or column, and are distinguishable by
formatting, e.g. bold for the top level, italic for the mid level, and plain for
the lowest level.</p>
<p>In this example, there is a single column of row headers, where the levels are
shown by different amounts of indentation. The indentation is done by
formatting, rather than by leading spaces or tabs.</p>
<p>The first step is to find the format IDs of all the different levels of
indentation.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb209-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb209-2" data-line-number="2">formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)</a>
<a class="sourceLine" id="cb209-3" data-line-number="3"></a>
<a class="sourceLine" id="cb209-4" data-line-number="4">indent0 &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>alignment<span class="op">$</span>indent <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb209-5" data-line-number="5">indent1 &lt;-<span class="st"> </span><span class="kw">which</span>(formats<span class="op">$</span>local<span class="op">$</span>alignment<span class="op">$</span>indent <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb209-6" data-line-number="6"></a>
<a class="sourceLine" id="cb209-7" data-line-number="7">indent0</a></code></pre></div>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
## [24] 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 42 43 44 45 46 47 48
## [47] 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66</code></pre>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb211-1" data-line-number="1">indent1</a></code></pre></div>
<pre><code>## [1] 40 41</code></pre>
<p>Now we use these format IDs to indentify the different levels of headers in the
first column.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb213-1" data-line-number="1">all_cells &lt;-</a>
<a class="sourceLine" id="cb213-2" data-line-number="2"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-hierarchy&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb213-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb213-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, local_format_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb213-5" data-line-number="5"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 16 x 6
##      row   col data_type character   numeric local_format_id
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;         &lt;dbl&gt;           &lt;int&gt;
##  1     2     3 character Matilda          NA              39
##  2     2     4 character Nicholas         NA              42
##  3     3     2 character Humanities       NA              39
##  4     4     2 character Classics         NA              40
##  5     4     3 numeric   &lt;NA&gt;              1              28
##  6     4     4 numeric   &lt;NA&gt;              3              37
##  7     5     2 character History          NA              40
##  8     5     3 numeric   &lt;NA&gt;              3              28
##  9     5     4 numeric   &lt;NA&gt;              5              37
## 10     6     2 character Performance      NA              35
## 11     7     2 character Music            NA              40
## 12     7     3 numeric   &lt;NA&gt;              5              28
## 13     7     4 numeric   &lt;NA&gt;              9              37
## 14     8     2 character Drama            NA              41
## 15     8     3 numeric   &lt;NA&gt;              7              30
## 16     8     4 numeric   &lt;NA&gt;             12              38</code></pre>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb215-1" data-line-number="1">field &lt;-</a>
<a class="sourceLine" id="cb215-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>indent0) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb215-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">field =</span> character)</a>
<a class="sourceLine" id="cb215-4" data-line-number="4">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb215-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb215-6" data-line-number="6">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb215-7" data-line-number="7">field</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col field      
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     3     2 Humanities 
## 2     6     2 Performance</code></pre>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb217-1" data-line-number="1">subject &lt;-</a>
<a class="sourceLine" id="cb217-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>, local_format_id <span class="op">%in%</span><span class="st"> </span>indent1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb217-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb217-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb217-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb217-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb217-7" data-line-number="7">subject</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     4     2 Classics
## 2     5     2 History 
## 3     7     2 Music   
## 4     8     2 Drama</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb219-1" data-line-number="1">name &lt;-</a>
<a class="sourceLine" id="cb219-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb219-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb219-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb219-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb219-6" data-line-number="6">name</a></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##     row   col name    
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     2     3 Matilda 
## 2     2     4 Nicholas</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb221-1" data-line-number="1">data_cells &lt;-</a>
<a class="sourceLine" id="cb221-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb221-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb221-4" data-line-number="4">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb221-5" data-line-number="5">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb221-6" data-line-number="6">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb221-7" data-line-number="7">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb221-8" data-line-number="8"></a>
<a class="sourceLine" id="cb221-9" data-line-number="9">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb221-10" data-line-number="10"><span class="st">  </span><span class="kw">enhead</span>(field, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb221-11" data-line-number="11"><span class="st">  </span><span class="kw">enhead</span>(subject, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb221-12" data-line-number="12"><span class="st">  </span><span class="kw">enhead</span>(name, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb221-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 8 x 4
##   score field       subject  name    
##   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   
## 1     1 Humanities  Classics Matilda 
## 2     3 Humanities  Classics Nicholas
## 3     3 Humanities  History  Matilda 
## 4     5 Humanities  History  Nicholas
## 5     5 Performance Music    Matilda 
## 6     9 Performance Music    Nicholas
## 7     7 Performance Drama    Matilda 
## 8    12 Performance Drama    Nicholas</code></pre>
</div>
<div id="repeated-rowscolumns-of-headers-within-the-table" class="section level3">
<h3><span class="header-section-number">4.2.8</span> Repeated rows/columns of headers within the table</h3>
<p><img src="images/pivot-repeated-headers.png" /></p>
<p>Repetitions can simply be ignored. Select one of the sets of headers, and use
it for all the data. In this example, the data cells are easy to distinguish
from the headers mixed in among them, because only the data cells have the
<code>numeric</code> data type.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb223-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb223-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb223-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-repeated-headers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb223-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb223-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb223-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 80 x 5
##      row   col data_type character numeric
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
##  1     2     4 character Term 1         NA
##  2     2     5 character Term 2         NA
##  3     2     6 character Term 3         NA
##  4     3     2 character Classics       NA
##  5     3     3 character Matilda        NA
##  6     3     4 numeric   &lt;NA&gt;            8
##  7     3     5 numeric   &lt;NA&gt;            5
##  8     3     6 numeric   &lt;NA&gt;            7
##  9     4     3 character Nicholas       NA
## 10     4     4 numeric   &lt;NA&gt;            4
## # ... with 70 more rows</code></pre>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb225-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 20 x 6
##    `row/col` `2(B)`   `3(C)`   `4(D)` `5(E)` `6(F)`
##        &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
##  1         2 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
##  2         3 Classics Matilda  8      5      7     
##  3         4 &lt;NA&gt;     Nicholas 4      5      7     
##  4         5 &lt;NA&gt;     Olivia   0      7      3     
##  5         6 &lt;NA&gt;     Paul     5      1      2     
##  6         7 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
##  7         8 History  Matilda  2      9      6     
##  8         9 &lt;NA&gt;     Nicholas 4      2      4     
##  9        10 &lt;NA&gt;     Olivia   8      9      6     
## 10        11 &lt;NA&gt;     Paul     4      4      9     
## 11        12 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
## 12        13 Music    Matilda  3      1      6     
## 13        14 &lt;NA&gt;     Nicholas 1      6      2     
## 14        15 &lt;NA&gt;     Olivia   9      1      6     
## 15        16 &lt;NA&gt;     Paul     7      9      3     
## 16        17 &lt;NA&gt;     &lt;NA&gt;     Term 1 Term 2 Term 3
## 17        18 Drama    Matilda  1      1      0     
## 18        19 &lt;NA&gt;     Nicholas 9      9      7     
## 19        20 &lt;NA&gt;     Olivia   5      6      1     
## 20        21 &lt;NA&gt;     Paul     7      4      5</code></pre>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb227-1" data-line-number="1"><span class="co"># The &#39;term&#39; headers appear four times, but only the first one is needed.</span></a>
<a class="sourceLine" id="cb227-2" data-line-number="2">term &lt;-</a>
<a class="sourceLine" id="cb227-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb227-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">term =</span> character)</a>
<a class="sourceLine" id="cb227-5" data-line-number="5">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb227-6" data-line-number="6">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb227-7" data-line-number="7">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb227-8" data-line-number="8">term</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##     row   col term  
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     2     4 Term 1
## 2     2     5 Term 2
## 3     2     6 Term 3</code></pre>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb229-1" data-line-number="1">subject &lt;-</a>
<a class="sourceLine" id="cb229-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb229-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb229-4" data-line-number="4">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb229-5" data-line-number="5">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb229-6" data-line-number="6">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb229-7" data-line-number="7">subject</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     3     2 Classics
## 2     8     2 History 
## 3    13     2 Music   
## 4    18     2 Drama</code></pre>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb231-1" data-line-number="1">name &lt;-</a>
<a class="sourceLine" id="cb231-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb231-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb231-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb231-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb231-6" data-line-number="6">name</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col name    
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
##  1     3     3 Matilda 
##  2     4     3 Nicholas
##  3     5     3 Olivia  
##  4     6     3 Paul    
##  5     8     3 Matilda 
##  6     9     3 Nicholas
##  7    10     3 Olivia  
##  8    11     3 Paul    
##  9    13     3 Matilda 
## 10    14     3 Nicholas
## 11    15     3 Olivia  
## 12    16     3 Paul    
## 13    18     3 Matilda 
## 14    19     3 Nicholas
## 15    20     3 Olivia  
## 16    21     3 Paul</code></pre>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb233-1" data-line-number="1"><span class="co"># The data cells are distinguished from the &#39;term&#39; headers by their data type --</span></a>
<a class="sourceLine" id="cb233-2" data-line-number="2"><span class="co"># the data cells are numeric, whereas the term headers are character.</span></a>
<a class="sourceLine" id="cb233-3" data-line-number="3">data_cells &lt;-</a>
<a class="sourceLine" id="cb233-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb233-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb233-6" data-line-number="6">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb233-7" data-line-number="7">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb233-8" data-line-number="8">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb233-9" data-line-number="9">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb233-10" data-line-number="10">data_cells</a></code></pre></div>
<pre><code>## # A tibble: 48 x 3
##      row   col score
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
##  1     3     4     8
##  2     3     5     5
##  3     3     6     7
##  4     4     4     4
##  5     4     5     5
##  6     4     6     7
##  7     5     4     0
##  8     5     5     7
##  9     5     6     3
## 10     6     4     5
## # ... with 38 more rows</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb235-1" data-line-number="1">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb235-2" data-line-number="2"><span class="st">  </span><span class="kw">enhead</span>(term, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb235-3" data-line-number="3"><span class="st">  </span><span class="kw">enhead</span>(subject, <span class="st">&quot;NNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb235-4" data-line-number="4"><span class="st">  </span><span class="kw">enhead</span>(name, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb235-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    score term   subject  name    
##    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt;   
##  1     8 Term 1 Classics Matilda 
##  2     5 Term 2 Classics Matilda 
##  3     7 Term 3 Classics Matilda 
##  4     4 Term 1 Classics Nicholas
##  5     5 Term 2 Classics Nicholas
##  6     7 Term 3 Classics Nicholas
##  7     0 Term 1 Classics Olivia  
##  8     7 Term 2 Classics Olivia  
##  9     3 Term 3 Classics Olivia  
## 10     5 Term 1 Classics Paul    
## # ... with 38 more rows</code></pre>
</div>
<div id="headers-amongst-the-data" class="section level3">
<h3><span class="header-section-number">4.2.9</span> Headers amongst the data</h3>
<p><img src="images/pivot-header-within-data.png" /></p>
<p>This happens when what is actually a row-header, instead of being presented to
the left of the data, is presented above the data. (Alternatively, what is
actually a column header, instead of being presented above the data, is
presented to the side.)</p>
<p>The way to handle it is to <em>pretend</em> that it is a row header, and use the
<code>&quot;WNW&quot;</code> direction as normal.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb237-1" data-line-number="1">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb237-2" data-line-number="2">all_cells &lt;-</a>
<a class="sourceLine" id="cb237-3" data-line-number="3"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheets =</span> <span class="st">&quot;pivot-header-within-data&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, local_format_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-6" data-line-number="6"><span class="st">  </span><span class="kw">print</span>()</a></code></pre></div>
<pre><code>## # A tibble: 80 x 6
##      row   col data_type character numeric local_format_id
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;           &lt;int&gt;
##  1     2     3 character Classics       NA              64
##  2     3     3 character Term 1         NA              28
##  3     3     4 character Term 2         NA              44
##  4     3     5 character Term 3         NA              29
##  5     4     2 character Matilda        NA              26
##  6     4     3 numeric   &lt;NA&gt;            1              26
##  7     4     4 numeric   &lt;NA&gt;            3              48
##  8     4     5 numeric   &lt;NA&gt;            2              27
##  9     5     2 character Nicholas       NA              28
## 10     5     3 numeric   &lt;NA&gt;            8              28
## # ... with 70 more rows</code></pre>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb239-1" data-line-number="1"><span class="co"># View the cells in their original positions on the spreadsheet</span></a>
<a class="sourceLine" id="cb239-2" data-line-number="2"><span class="kw">rectify</span>(all_cells)</a></code></pre></div>
<pre><code>## # A tibble: 24 x 5
##    `row/col` `2(B)`   `3(C)`   `4(D)` `5(E)`
##        &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
##  1         2 &lt;NA&gt;     Classics &lt;NA&gt;   &lt;NA&gt;  
##  2         3 &lt;NA&gt;     Term 1   Term 2 Term 3
##  3         4 Matilda  1        3      2     
##  4         5 Nicholas 8        0      6     
##  5         6 Olivia   8        9      6     
##  6         7 Paul     8        8      2     
##  7         8 &lt;NA&gt;     History  &lt;NA&gt;   &lt;NA&gt;  
##  8         9 &lt;NA&gt;     Term 1   Term 2 Term 3
##  9        10 Matilda  5        3      5     
## 10        11 Nicholas 4        7      8     
## # ... with 14 more rows</code></pre>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb241-1" data-line-number="1">bold &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>bold)</a>
<a class="sourceLine" id="cb241-2" data-line-number="2"></a>
<a class="sourceLine" id="cb241-3" data-line-number="3"><span class="co"># The subject headers, though mixed with the data and the &#39;term&#39; headers, are</span></a>
<a class="sourceLine" id="cb241-4" data-line-number="4"><span class="co"># distinguishable by the data type &quot;character&quot; and by being bold.</span></a>
<a class="sourceLine" id="cb241-5" data-line-number="5">subject &lt;-</a>
<a class="sourceLine" id="cb241-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells,</a>
<a class="sourceLine" id="cb241-7" data-line-number="7">         col <span class="op">==</span><span class="st"> </span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb241-8" data-line-number="8">         data_type <span class="op">==</span><span class="st"> &quot;character&quot;</span>,</a>
<a class="sourceLine" id="cb241-9" data-line-number="9">         local_format_id <span class="op">%in%</span><span class="st"> </span>bold) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb241-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">subject =</span> character)</a>
<a class="sourceLine" id="cb241-11" data-line-number="11">  <span class="co"># The title of this header is &#39;subject&#39;</span></a>
<a class="sourceLine" id="cb241-12" data-line-number="12">  <span class="co"># The cells are text cells (`&quot;history&quot;`, etc.) so take the value in the</span></a>
<a class="sourceLine" id="cb241-13" data-line-number="13">  <span class="co"># &#39;`character` column.</span></a>
<a class="sourceLine" id="cb241-14" data-line-number="14">subject</a></code></pre></div>
<pre><code>## # A tibble: 4 x 3
##     row   col subject 
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
## 1     2     3 Classics
## 2     8     3 History 
## 3    14     3 Music   
## 4    20     3 Drama</code></pre>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb243-1" data-line-number="1"><span class="co"># We only need one set of the &#39;term&#39; headers</span></a>
<a class="sourceLine" id="cb243-2" data-line-number="2">term &lt;-</a>
<a class="sourceLine" id="cb243-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, row <span class="op">==</span><span class="st"> </span><span class="dv">3</span>, data_type <span class="op">==</span><span class="st"> &quot;character&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb243-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">term =</span> character)</a>
<a class="sourceLine" id="cb243-5" data-line-number="5">  <span class="co"># the title of this header is &#39;field&#39;, meaning &#39;group of subjects&#39;.</span></a>
<a class="sourceLine" id="cb243-6" data-line-number="6">  <span class="co"># The cells are text cells (`&quot;Humanities&quot;`, `&quot;Performance&quot;`) so take the value</span></a>
<a class="sourceLine" id="cb243-7" data-line-number="7">  <span class="co"># in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb243-8" data-line-number="8">term</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##     row   col term  
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
## 1     3     3 Term 1
## 2     3     4 Term 2
## 3     3     5 Term 3</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb245-1" data-line-number="1">name &lt;-</a>
<a class="sourceLine" id="cb245-2" data-line-number="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb245-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">name =</span> character)</a>
<a class="sourceLine" id="cb245-4" data-line-number="4">  <span class="co"># The title of this header is &#39;name&#39;.</span></a>
<a class="sourceLine" id="cb245-5" data-line-number="5">  <span class="co"># The cells are text cells, so take the value in the &#39;`character` column.</span></a>
<a class="sourceLine" id="cb245-6" data-line-number="6">name</a></code></pre></div>
<pre><code>## # A tibble: 16 x 3
##      row   col name    
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   
##  1     4     2 Matilda 
##  2     5     2 Nicholas
##  3     6     2 Olivia  
##  4     7     2 Paul    
##  5    10     2 Matilda 
##  6    11     2 Nicholas
##  7    12     2 Olivia  
##  8    13     2 Paul    
##  9    16     2 Matilda 
## 10    17     2 Nicholas
## 11    18     2 Olivia  
## 12    19     2 Paul    
## 13    22     2 Matilda 
## 14    23     2 Nicholas
## 15    24     2 Olivia  
## 16    25     2 Paul</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb247-1" data-line-number="1"><span class="co"># The data cells are distinguished from the &#39;subject&#39; headers by their data</span></a>
<a class="sourceLine" id="cb247-2" data-line-number="2"><span class="co"># type -- the data cells are numeric, whereas the term headers are character.</span></a>
<a class="sourceLine" id="cb247-3" data-line-number="3">data_cells &lt;-</a>
<a class="sourceLine" id="cb247-4" data-line-number="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(all_cells, data_type <span class="op">==</span><span class="st"> &quot;numeric&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb247-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">score =</span> numeric)</a>
<a class="sourceLine" id="cb247-6" data-line-number="6">  <span class="co"># The data is exam scores in certain subjects, so give the data that title.</span></a>
<a class="sourceLine" id="cb247-7" data-line-number="7">  <span class="co"># The data is numeric, so select only that &#39;value&#39;.  If some of the data was</span></a>
<a class="sourceLine" id="cb247-8" data-line-number="8">  <span class="co"># also text or true/false, then you would select the `character` and `logical`</span></a>
<a class="sourceLine" id="cb247-9" data-line-number="9">  <span class="co"># columns as well as `numeric`</span></a>
<a class="sourceLine" id="cb247-10" data-line-number="10">data_cells</a></code></pre></div>
<pre><code>## # A tibble: 48 x 3
##      row   col score
##    &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
##  1     4     3     1
##  2     4     4     3
##  3     4     5     2
##  4     5     3     8
##  5     5     4     0
##  6     5     5     6
##  7     6     3     8
##  8     6     4     9
##  9     6     5     6
## 10     7     3     8
## # ... with 38 more rows</code></pre>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb249-1" data-line-number="1">data_cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb249-2" data-line-number="2"><span class="st">  </span><span class="kw">enhead</span>(subject, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb249-3" data-line-number="3"><span class="st">  </span><span class="kw">enhead</span>(term, <span class="st">&quot;N&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb249-4" data-line-number="4"><span class="st">  </span><span class="kw">enhead</span>(name, <span class="st">&quot;W&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb249-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row, <span class="op">-</span>col)</a></code></pre></div>
<pre><code>## # A tibble: 48 x 4
##    score subject  term   name    
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;   
##  1     1 Classics Term 1 Matilda 
##  2     3 Classics Term 2 Matilda 
##  3     2 Classics Term 3 Matilda 
##  4     8 Classics Term 1 Nicholas
##  5     0 Classics Term 2 Nicholas
##  6     6 Classics Term 3 Nicholas
##  7     8 Classics Term 1 Olivia  
##  8     9 Classics Term 2 Olivia  
##  9     6 Classics Term 3 Olivia  
## 10     8 Classics Term 1 Paul    
## # ... with 38 more rows</code></pre>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidy-clean.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="small-multiples.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
